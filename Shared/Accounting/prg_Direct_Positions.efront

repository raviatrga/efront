//*******************************************************
// Created on 10/25/2018 by DD
// Code combines Directs Position Query to the VCINVESTMENTOP 
//     table by IQID  
//*************
// Trans Types:
// LN07	    LN-Upfront Origination Fee Income
// LN51	    LN-Capitalized Interest
// LN05	    LN-Other Income (Accretion/Amortization)
// LN41	    LN-Cash interest
// LN21     Loan - PIK
//*************
// 10/30 -  DD added ABS to the GAAP_Mezzanine_Income field
// 12/14 -  DD change the calc for GAAP_Mezzanine_Income to only add Amount2 if Type <> LN41
// 01/23 -  DD Keaton requested to change the logic to handle reverse transactions
//*******************************************************

LIBNAME LOCAL ".";

%param Start_Date TYPE=DATE label="<b>To Date:(mm-dd-yyyy)</b><BR><BR>"; //default="05-10-2018 14:00:00" ;
%param End_Date TYPE=DATE label="<b>From Date:(mm-dd-yyyy)</b><BR><BR>" default="12-01-2099" ;


// Query filters for Trans Type ('LN07', 'LM51', 'LN05', 'LN41') 
PROC FAQUERY Query="IT Admin - Program Queries\qry_Directs_Position"(Date=%End_Date); 
   TABLE "Default"  OUT = WORK.Directs_Pos_Qry;
RUN;
//PROC PRINT DATA = WORK.Directs_Pos_Qry LABEL; RUN;

// Lets get all Investment OP Values  
DATA WORK.Invest_op_Values;
   SQL  "SELECT IQID
              , ABS(isnull(Amount,0))         Amount 
              , ABS(isnull(Amount2,0))   Amount2_Instr
              , Amount3 
              , Amount4 
              , Amount5  
              , ABS(isnull(Amount6,0))   Amount6_Due_Instr
              , Amount7
              , AMOUNTX 
              , ABS(isnull(AMOUNTX2,0))  AMOUNTX2 
              , AMOUNTX3 
              , AMOUNTX4 
              , AMOUNTX5 
              , AMOUNTX6 
              , AMOUNTX7 
              , ABS(isnull(AmountX2,0)) + 
                                        Case When TYPEINVESTOP = 'LN41' Then 0 
                                             When REVERSETRANSACTION is not null 
                                                then isnull(Amount2,0)            -- there is a reversal do not take ABS     
                                           Else ABS(isnull(Amount2,0))
                                         End 
                                        as GAAP_Mezzanine_Income 
              , ACCOUNT
              , TYPEINVESTOP 
           from VCINVESTMENTOP 
             where TYPEINVESTOP in ('LN07', 'LN51', 'LN05', 'LN41') 
               and IQDELETED = 0
";
COLUMN IQID; RUN;
PROC PRINT DATA = WORK.Invest_op_Values; title 'SQL Output Invest_op_Values'; RUN;  

// Merge Op Values and POS Query by IQID
DATA WORK.Direct_Pos_Output;
  MERGE WORK.Invest_op_Values(IN=IN1) WORK.Directs_Pos_Qry(IN=IN2);
  BY IQID;
  IF (IN1 AND IN2) 
    THEN OUTPUT;
  END;
RUN; 
//PROC PRINT DATA = WORK.Direct_Pos_Output LABEL; RUN;  


// Sort records by Company ASC
PROC SORT DATA = WORK.Direct_Pos_Output
OUT = WORK.Direct_Pos_Output ;
BY INSTRUMENT Company Investor;  //COMPANY;
RUN;
//PROC PRINT DATA = WORK.Direct_Pos_Output LABEL; RUN;

//, Aladdin CUSIP, Company, Investor

// Check to see if Start Date is blank if so pull all records
// if not blank pull by Date range
%If %Start_Date = "" %Then  
    DATA local.Tab_Direct_Pos_Output; 
      SET WORK.Direct_Pos_Output  ; 
    RUN;
  %Else
    DATA local.Tab_Direct_Pos_Output; 
      SET WORK.Direct_Pos_Output (where DML(Effective_date) >= DML(%Start_Date) and DML(Effective_date) <= DML(%End_Date)); 
    RUN;
%END;    

//PROC PRINT DATA = local.Tab_Direct_Pos_Output LABEL; RUN;





