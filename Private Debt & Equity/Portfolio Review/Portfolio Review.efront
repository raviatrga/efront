LIBNAME USER ".";

%DEFINE REPORT_DATE;
%DEFINE CALCULATE_IRR;
%DEFINE USE_INVESTEE_CURR;

%PARAM DATE LABEL="As of Date" TYPE=DATE DEFAULT=TODAY NOTNULL;
%LET DATE=%DATE;

/*------------------5. Funds by Vintage-------------------*/ 
//JOIN VCFUNDSTAT FSTAT ON A.FSTATUS = FSTAT.CODE AND FSTAT.DESCR = 'Fund (Closed Ended)'
/*
Fund Asset Class3
1;Real Estate Joint Ventures (REJV)
2;Alternatives Debt Fund
3;Direct Private Debt
4;Private Debt Fund
5;Structured Alternatives Debt Fund
6;Structured Alternatives Direct Debt
7;Alternatives Equity Fund
8;Direct Private Equity
9;Private Equity Fund
10;Structured Alternatives Direct Equity
11;Structured Alternatives Equity Fund

*/

DATA WORK.FUNDMAST;
SQL "SELECT A.IQID AS FUND_ID,
    MIN(A.FUND) as FUNDNAME ,
    MIN(VCPRT.PORTFOLIO) as PORTFOLIO,
    (case 
		when MIN(A.USERTEXT43) = '1' then 'Debt Hedge Fund' 
		when MIN(A.USERTEXT43) = '2' then 'Alternatives Preferred Stock' 
		when MIN(A.USERTEXT43) = '3' then 'Senior Secured Loan' 
		when MIN(A.USERTEXT43) = '4' then 'Subordinated Loan' 
		when MIN(A.USERTEXT43) = '5' then 'Distressed Debt' 
		when MIN(A.USERTEXT43) = '6' then 'Real Asset Debt' 
		when MIN(A.USERTEXT43) = '7' then 'Senior Secured Loan' 
		when MIN(A.USERTEXT43) = '8' then 'Subordinated Loan/Mezzanine Funds' 
		when MIN(A.USERTEXT43) = '9' then 'Senior Secured Loan' 
		when MIN(A.USERTEXT43) = '10' then 'Subordinated Loan' 
		when MIN(A.USERTEXT43) = '11' then 'Senior Secured Loan' 
		when MIN(A.USERTEXT43) = '12' then 'Subordinated Loan' 
		when MIN(A.USERTEXT43) = '13' then 'Equity Hedge Fund' 
		when MIN(A.USERTEXT43) = '14' then 'Alternatives Common Stock' 
		when MIN(A.USERTEXT43) = '15' then 'Alternatives Preferred Stock' 
		when MIN(A.USERTEXT43) = '16' then 'Warrants' 
		when MIN(A.USERTEXT43) = '17' then 'Buyout' 
		when MIN(A.USERTEXT43) = '18' then 'Growth' 
		when MIN(A.USERTEXT43) = '19' then 'Real Asset Equity' 
		when MIN(A.USERTEXT43) = '20' then 'Secondary' 
		when MIN(A.USERTEXT43) = '21' then 'Venture Capital' 
		when MIN(A.USERTEXT43) = '22' then 'Structured Alternatives Common Stock' 
		when MIN(A.USERTEXT43) = '23' then 'Structured Alternatives Preferred Stock' 
		when MIN(A.USERTEXT43) = '24' then 'Senior Loan' 
		when MIN(A.USERTEXT43) = '25' then 'Subordinated Loan' 
  end) + 
	(case 
		when MIN(A.USERTEXT44) = '1' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '2' then '/Direct Investment' 
		when MIN(A.USERTEXT44) = '3' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '4' then '/Direct Investment' 
		when MIN(A.USERTEXT44) = '5' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '6' then '/Direct Investment' 
		when MIN(A.USERTEXT44) = '7' then '/Agriculture' 
		when MIN(A.USERTEXT44) = '8' then '/Energy' 
		when MIN(A.USERTEXT44) = '9' then '/Infrastructure' 
		when MIN(A.USERTEXT44) = '10' then '/Real Estate' 
		when MIN(A.USERTEXT44) = '11' then '/Timber' 
		when MIN(A.USERTEXT44) = '12' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '13' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '14' then '/Co-Investment' 
		when MIN(A.USERTEXT44) = '15' then '/Agriculture' 
		when MIN(A.USERTEXT44) = '16' then '/Energy' 
		when MIN(A.USERTEXT44) = '17' then '/Infrastructure' 
		when MIN(A.USERTEXT44) = '18' then '/Real Estate' 
		when MIN(A.USERTEXT44) = '19' then '/Timber' 
     else ' '                                                                                                                                                                                
end) as Sectors,
    MIN(A.VINTAGEYEAR) as 'Vintage',                                                                                                                                                                            
    MIN(A.USERCURR3) as 'RGA_Orig_Commit', 
    MIN(A.USERCURR2) as 'Total_Fund_Size',                                                                                                                                                                            
    MIN(QTR.GAAP_INCOME_ITD) as 'GAAP_INCOME_ITD',
    MIN(A.CURRENCY1 ) as 'CURRENCY1',
    MIN(A.CLOSINGDATE ) as 'CLOSEDATE',
    MIN(A.ENDDATE ) as 'ENDDATE', 
    MIN(VCSUB.EXITDATE),
    (case  when MIN(FSTAT.DESCR) not like 'Exited Fund%' then '1'  else '0' end ) as 'FACTIVESTATUS' ,
    (case 
		when MIN(A.USERTEXT42) = '4' then 'Private Debt Fund' 
		when MIN(A.USERTEXT42) = '9' then 'Private Equity Fund'                                                                                                                                                                             
    end) as  FUND_CLASS3 ,
    MIN(VCSUB.LIBELLE) INVESTORNAME
     FROM VCFUND A
     JOIN VCSUBSCRIBER VCSUB ON VCSUB.FUND = A.IQID
     JOIN VCPORTFOLIOASSET VCPRTAST ON VCPRTAST.SUBSCRIBER = VCSUB.IQID AND  VCPRTAST.IQDELETED=0   
     JOIN VCPORTFOLIO VCPRT ON VCPRT.IQID = VCPRTAST.PORTFOLIO  AND  VCPRT.IQDELETED=0 AND VCPRT.PORTFOLIO IN ('PDE - Funds')                                                                                                                                                                         
     JOIN ADMROLE REG ON A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity') 
     JOIN VCFUNDSTAT FSTAT ON A.FSTATUS = FSTAT.CODE 
     LEFT JOIN ( SELECT SUBOP.FUND FUND, SUM(SUBOP.AMOUNT83) GAAP_INCOME_ITD
	                FROM VCSUBSCRFUNDOPSHARE SUBOP  
	                JOIN VCFUNDOP OP ON SUBOP.FUNDOP = OP.IQID 
                    JOIN VCFUNDOPTYPE OPT ON OP.OTYPE = OPT.CODE AND OPT.DESCR IN ('IF: Quarterly Income Analysis','IF: Equity Income Analysis') 
	                WHERE OP.USERDATE3 = (SELECT MAX(OP1.USERDATE3) FROM VCFUNDOP OP1 WHERE OP1.FUND = OP.FUND 
                                                AND OP1.OTYPE = OP.OTYPE AND OP1.USERDATE3 <= " & DML(%DATE) & ")  
	                GROUP BY SUBOP.FUND	   
                    ) QTR ON QTR.FUND = A.IQID                                                                                                                                                                 
    WHERE A.IQDELETED=0 
    AND ((A.USERTEXT42 = '4' AND A.USERTEXT43 IN ('5','8')) OR A.USERTEXT42 = '9')
    AND ??FILTER
    GROUP BY A.IQID  ";
COLUMN FUND_ID; RUN;       
                                                                                                                                                                                  
//DATA WORK.tmp1 (KEEP = FUND_ID FUND INVESTOR_ID INVESTORNAME CURRENTCOST REMAININGCOMMITMENT CAPITALINVESTED RETURNOFCAPITAL LASTVALUATION );
DATA WORK.tmp1 (KEEP = FUND_ID FUND INVESTOR_ID INVESTORNAME REMAININGCOMMITMENT CAPITALINVESTED RETURNOFCAPITAL LASTVALUATION );
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE) ;
RUN;                                                                                                                                                                                    
//PROC PRINT DATA=WORK.tmp1; RUN;

DATA WORK.FUND_LIST;
MERGE WORK.FUNDMAST(IN=IN1) WORK.tmp1(IN=IN2);
By FUND_ID INVESTORNAME  ;
If (IN1 and IN2) then Output;
End;
RUN;  
   
//PROC PRINT DATA =  WORK.FUND_LIST; RUN;    
//0809 
                                                                                                                                                                                       
PROC FAQUERY Query="IT Admin - Program Queries\Positions-PortRev" (DATE=%DATE) ; 
    TABLE "Default"  OUT=WORK.QRY_POSITIONS_PORTREV;
RUN;
//PROC PRINT DATA=WORK.QRY_POSITIONS_PORTREV; RUN;

DATA WORK.FUND_LIST;
MERGE WORK.FUND_LIST(IN=IN1) WORK.QRY_POSITIONS_PORTREV(IN=IN2);
By FUND_ID INVESTORNAME  ;
If (IN1 and IN2) then Output;
End;
RUN; 

DATA WORK.FUND_LIST(DROP=FUND GAAP_BOOK_VALUE GL_COST_ELIM);
SET WORK.FUND_LIST;
 COLUMN CURRENTCOST  TYPE=DOUBLE;  CURRENTCOST = GAAP_BOOK_VALUE + GL_COST_ELIM;
RUN;
//PROC PRINT DATA =  WORK.FUND_LIST; RUN;     
//0809                                                                                                                                                                                        
                                                                                                                                                                                        
PROC MEANS DATA = FCE.FUNDOPERATIONS(WHERE OPERATIONDATE<=%DATE) OUT=WORK.TIRR;
CLASS FUND_ID OPERATIONDATE; 
VAR  FUNDNAME; 
SUM CASH(NAME=IRRNET);
RUN; 

PROC MEANS DATA =  WORK.FUND_LIST OUT=WORK.TVALUATION;
CLASS FUND_ID; 
VAR  FUNDNAME; 
SUM LASTVALUATION(NAME=IRRNET);
RUN; 

DATA WORK.TIRR;
SET  WORK.TIRR(IN=T1) WORK.TVALUATION; 
IF IRRNET IS NULL THEN IRRNET=0; END; 

COLUMN SORT_IRR TYPE=INTEGER; 

IF T1 THEN 
SORT_IRR=0;  
ELSE 
SORT_IRR=1; 
OPERATIONDATE=%DATE;
END; 
                                                                                                                                                                                       
_OUTPUT_=IRRNET <>0 OR SORT_IRR=1;
RUN; 

PROC SORT DATA = WORK.TIRR; 
BY FUND_ID FUNDNAME SORT_IRR OPERATIONDATE; 
RUN; 

DATA WORK.FUND_LIST1;
MERGE WORK.FUND_LIST(IN=IN1) WORK.TIRR(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                    
DATA FUND_LIST1(DROP = ENDDATE); 
SET WORK.FUND_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= RETURNOFCAPITAL+ LASTVALUATION;                                                                                                                                                                                     
RUN;      

/*------------------3. Direct Mezz by Vintage-------------------*/ 
                                                                                                                                                                                    
DATA WORK.INVSTINS;
    SQL "SELECT MIN(INVINS.ACCOUNTINS) INVINS_ACCOUNTINS,
        SUM(A.AMOUNT2*(-1)) INVESTMENT, DATEPART(YYYY,MIN(A.CLOSEDATE)) INV_YEAR,
    MIN(VCPRT.PORTFOLIO) as PORTFOLIO, MIN (A.CURRENCY6) INST_CURR, MIN(SFA.NAME) AS SPONSOR,
(case  when MIN(SFASTAT.DESCR) not like 'Exited Portfolio Co.%' then  '1' else '0' end ) as 'CMPACTIVESTATUS',
MIN(SFA_CMP.NAME) COMPANY,
MIN(SFA_CMP.CREATIONDATE) CREATIONDATE ,
    CASE WHEN CONVERT(VARCHAR(12),MIN(RATE.BASERATE)/100 ) IS NOT NULL THEN CONVERT(VARCHAR(12),MIN(RATE.BASERATE)/100 ) 
  ELSE  MIN(BNMK.LIBELLE) + ' + ' + CONVERT( VARCHAR(12),MIN(RATE.RATESTABLEPERCENT)/100) END  AS CASH ,                                                                                                                                                                                        
MIN(RATEPIK.BASERATE/100) PIK ,
MIN(VCP.USERDATE5) MATURITY_DATE                                                                                                                                                                                         
    FROM VCINVESTMENTINS INVINS 
        JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
        LEFT JOIN VCPROJECT VCP ON  VCP.ACCOUNT = VCINV.ACCOUNT AND VCP.WORKFLOW =
                                (SELECT IQID FROM ADMWORKFLOW WHERE LIBELLE IN ('RGA Direct Mezzanine'))
        LEFT JOIN SFAACCOUNT SFA ON SFA.IQID = VCP.USERTEXT7  
        LEFT JOIN SFAACCOUNT SFA_CMP ON SFA_CMP.IQID = VCINV.ACCOUNT                                                                                                                                                                                            
        LEFT JOIN SFAACCTSTAT SFASTAT ON SFA_CMP.STATUS = SFASTAT.CODE  AND  SFASTAT.FILTER NOT LIKE '000%' 
     LEFT JOIN VCINVESTINSRATE RATE ON RATE.INVESTMENTINS =  INVINS.ACCOUNTINS AND RATE.FIRSTDATE<= " & DML(%DATE) & " 
    AND RATE.LASTDATE>= " & DML(%DATE) & " AND RATE.KIND = (SELECT CODE FROM VCINVINSRATKIND WHERE DESCR IN ('Loan Cash Interests')  ) 
LEFT JOIN VCBENCHMARK BNMK ON BNMK.IQID=RATE.RATESTABLE                                                                                                                                                                                                 
LEFT JOIN VCINVESTINSRATE RATEPIK ON RATEPIK.INVESTMENTINS =  INVINS.ACCOUNTINS AND RATEPIK.FIRSTDATE<= " & DML(%DATE) & " 
     AND RATEPIK.LASTDATE>= " & DML(%DATE) & " AND RATEPIK.KIND = (SELECT CODE FROM VCINVINSRATKIND WHERE DESCR IN ('Loan Capitalized Interests')  )                                                                                                                                                                                                 
    JOIN VCPORTFOLIOASSET VCPRTAST ON VCPRTAST.INVESTMENT = VCINV.IQID AND  VCPRTAST.IQDELETED=0   
    JOIN VCPORTFOLIO VCPRT ON VCPRT.IQID = VCPRTAST.PORTFOLIO AND VCPRT.PORTFOLIO IN ('PDE - Direct Mezzanine')  AND  VCPRT.IQDELETED=0  
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'LN - Funding (w/o commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & DML(%DATE) & " AND ??FILTER
        GROUP BY  INVINS.ACCOUNTINS        " ;
    
    COLUMN SECURITY_ID;     
RUN;
//VCPRT.PORTFOLIO IN ('PDE - Direct Mezzanine')
//('PDE - Direct Investments')
//PROC PRINT DATA =  WORK.INVSTINS; RUN; 
                                                                                                                                                                                                    
PROC FAQUERY QUERY="IT Admin - Program Queries\Rating"; TABLE "Default" OUT=WORK.RATING; RUN;
//PROC PRINT DATA=WORK.RATING; RUN; 

DATA WORK.RATING(KEEP = SECURITY_ID RATING);
SET WORK.RATING (WHERE FROM <= %DATE AND TO >= %DATE );
RUN;                                                                                                                                                                                                    
                                                                                                                                                                                                    
DATA WORK.INVSTINS;
MERGE WORK.INVSTINS WORK.RATING;                                                                                                                                                                                                        
BY SECURITY_ID;
RUN;
                                                                                                                                                                                                    
//PROC PRINT DATA =  WORK.INVSTINS; RUN; 
                                                                                                                                                                                                    
DATA WORK.INSTRPOS_LN (KEEP = POSITION_DATE COMPANY_NAME SECURITY_NAME EXIT CURRENTCOST PRINCIPAL LASTVALUATION SECURITY_ID );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND SECURITY_CLASS_NAME ="LOANS" AND LENGTH(COMPANY_NAME)>0 );
RUN;

DATA WORK.DIRLOAN_LIST(RENAME = (SECURITY_ID=SECURITY_COMPANY_ID POSITION_DATE=REFERENCE_DATE));
MERGE WORK.INVSTINS(IN=IN1) WORK.INSTRPOS_LN(IN=IN2);
BY SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN; 

//PROC PRINT DATA = WORK.DIRLOAN_LIST; RUN;                                                                                                                                                                                              
                                                                                                                                                                                            
PROC MEANS DATA =DCE.FV_T_PORTCO_TRANSACTIONS(WHERE TRANSACTION_TYPE<>'LN05' AND TRANSACTION_TYPE<>'LN07' AND TRANSACTION_TYPE<>'EQ06') OUT=WORK.TIRR;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME; 
VAR  COMPANY_NAME;     
SUM CASH2(NAME=IRRNET);
RUN; 
                                                                                                                                                                                            
//PROC PRINT DATA= WORK.TIRR; RUN;
                                                                                                                                                                                            
PROC MEANS DATA =  WORK.DIRLOAN_LIST OUT=WORK.TVALUATION;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME;  
VAR  COMPANY_NAME;     
SUM LASTVALUATION(NAME=IRRNET);
RUN; 

DATA WORK.TIRR;
SET  WORK.TIRR(IN=T1) WORK.TVALUATION; 
IF IRRNET IS NULL THEN IRRNET=0; END; 

COLUMN SORT_IRR TYPE=INTEGER; 

IF T1 THEN SORT_IRR=0;  
ELSE SORT_IRR=1; 
REFERENCE_DATE=%DATE;
END; 

_OUTPUT_=IRRNET <>0 OR SORT_IRR=1;
RUN; 

PROC SORT DATA = WORK.TIRR; 
BY SECURITY_COMPANY_ID SECURITY_NAME COMPANY_NAME SORT_IRR REFERENCE_DATE; 
RUN; 

DATA WORK.DIRLOAN_LIST1;
MERGE WORK.DIRLOAN_LIST(IN=IN1) WORK.TIRR(IN=IN2);
By SECURITY_COMPANY_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                    
DATA DIRLOAN_LIST1; 
SET WORK.DIRLOAN_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN;    

/*------------------4. Direct Equity by Vintage-------------------*/    
//SUM(VCINV.OWNERSHIP) PERCENT_OWNERSHIP 
DATA WORK.INVSTINS_EQ;
    SQL "SELECT MIN(INVINS.ACCOUNTINS) INVINS_ACCOUNTINS,
        SUM(A.AMOUNT2*(-1)) INVESTMENT, DATEPART(YYYY,MIN(A.CLOSEDATE)) INV_YEAR,
    MIN(VCPRT.PORTFOLIO) as PORTFOLIO, MIN (A.CURRENCY6) INST_CURR, MIN(SFA.NAME) AS SPONSOR,
    (case  when MIN(SFASTAT.DESCR) not like 'Exited Portfolio Co.%' then  '1' else '0' end ) as 'CMPACTIVESTATUS',
 MIN(SFA_CMP.NAME)  COMPANY,
MIN(SFA_CMP.CREATIONDATE) CREATIONDATE , 
MIN(INVINS.LIBELLE) FUND, 
(case 
		when MIN(INVINS.USERTEXT21) = 1 then 'Fund' 
		when MIN(INVINS.USERTEXT21) = 2 then 'Company' 
    end) as LP_TYPE 
    FROM VCINVESTMENTINS INVINS 
        JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
        LEFT JOIN VCPROJECT VCP ON  VCP.ACCOUNT = VCINV.ACCOUNT AND VCP.WORKFLOW =
    (SELECT TOP 1 IQID FROM ADMWORKFLOW WHERE LIBELLE IN ('RGA Direct Mezzanine','RGA Equity Co-Investment'))
        LEFT JOIN SFAACCOUNT SFA ON SFA.IQID = VCP.USERTEXT7  
        LEFT JOIN SFAACCOUNT SFA_CMP ON SFA_CMP.IQID = VCINV.ACCOUNT                                                                                                                                                                                            
        LEFT JOIN SFAACCTSTAT SFASTAT ON SFA_CMP.STATUS = SFASTAT.CODE AND  SFASTAT.FILTER NOT LIKE '000%'                                                                                                                                                                                                    
    JOIN VCPORTFOLIOASSET VCPRTAST ON VCPRTAST.INVESTMENT = VCINV.IQID  AND  VCPRTAST.IQDELETED=0  
        JOIN VCPORTFOLIO VCPRT ON VCPRT.IQID = VCPRTAST.PORTFOLIO AND VCPRT.PORTFOLIO IN ('PDE - Direct Equity') AND  VCPRT.IQDELETED=0  
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'EQ - Purchase/Subscription (w/o Commitment)%'
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & DML(%DATE) & " AND ??FILTER
        GROUP BY  INVINS.ACCOUNTINS        " ;
    
    COLUMN SECURITY_ID;     
RUN;
//VCPRT.PORTFOLIO IN ('PDE - Direct Equity') ('PDE - Direct Investments')
//PROC PRINT DATA =  WORK.INVSTINS_EQ; RUN;  
                                                                                                                                                                                                    
DATA WORK.INSTRPOS_EQ (KEEP = POSITION_DATE COMPANY_NAME SECURITY_NAME EXIT CURRENTCOST LASTVALUATION SECURITY_ID );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND SECURITY_CLASS_NAME <>"LOANS" AND LENGTH(COMPANY_NAME)>0 );
RUN;

DATA WORK.DIREQUITY_LIST(RENAME = (SECURITY_ID=SECURITY_COMPANY_ID POSITION_DATE=REFERENCE_DATE));
MERGE WORK.INVSTINS_EQ(IN=IN1) WORK.INSTRPOS_EQ(IN=IN2);
BY SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN; 

//PROC PRINT DATA=WORK.DIREQUITY_LIST; RUN;
//0809

PROC FAQUERY Query="IT Admin - Program Queries\Positions-PortRev" (DATE=%DATE) ; 
    TABLE "Default"  OUT=WORK.QRY_POSITIONS_PORTREV;
RUN;
//PROC PRINT DATA=WORK.QRY_POSITIONS_PORTREV; RUN;

DATA WORK.QRY_POSITIONS_PORTREV(DROP = LASTVALUATION);
SET WORK.QRY_POSITIONS_PORTREV;
RUN;

DATA WORK.DIREQUITY_LIST;
MERGE WORK.DIREQUITY_LIST(IN=IN1) WORK.QRY_POSITIONS_PORTREV;
BY FUND  ;
If (IN1) then Output;
End;
RUN; 
//PROC PRINT DATA=WORK.DIREQUITY_LIST; RUN;

DATA WORK.DIREQUITY_LIST(DROP=FUND_ID FUND INVESTORNAME GAAP_BOOK_VALUE GL_COST_ELIM );
SET WORK.DIREQUITY_LIST;
// COLUMN CURRENTCOST  TYPE=DOUBLE;  
     IF LP_TYPE = 'Fund' THEN CURRENTCOST = GAAP_BOOK_VALUE + GL_COST_ELIM; END;
RUN;

//PROC PRINT DATA=WORK.DIREQUITY_LIST; RUN;
//0809

PROC MEANS DATA =DCE.FV_T_PORTCO_TRANSACTIONS(WHERE TRANSACTION_TYPE<>'LN05' AND TRANSACTION_TYPE<>'LN07' AND TRANSACTION_TYPE<>'EQ06') OUT=WORK.TIRR_EQ;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME; 
VAR  COMPANY_NAME;     
SUM CASH2(NAME=IRRNET);
RUN; 

PROC MEANS DATA =  WORK.DIREQUITY_LIST OUT=WORK.TVALUATION_EQ;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME;  
VAR  COMPANY_NAME;     
SUM LASTVALUATION(NAME=IRRNET);
RUN; 

DATA WORK.TIRR_EQ;
SET  WORK.TIRR_EQ(IN=T1) WORK.TVALUATION_EQ; 
IF IRRNET IS NULL THEN IRRNET=0; END; 

COLUMN SORT_IRR TYPE=INTEGER; 

IF T1 THEN SORT_IRR=0;  
ELSE SORT_IRR=1; 
REFERENCE_DATE=%DATE;
END; 

_OUTPUT_=IRRNET <>0 OR SORT_IRR=1;
RUN; 

PROC SORT DATA = WORK.TIRR_EQ; 
BY SECURITY_COMPANY_ID SECURITY_NAME COMPANY_NAME SORT_IRR REFERENCE_DATE; 
RUN; 

DATA WORK.DIREQUITY_LIST1;
MERGE WORK.DIREQUITY_LIST(IN=IN1) WORK.TIRR_EQ(IN=IN2);
By SECURITY_COMPANY_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                    
DATA DIREQUITY_LIST1; 
SET WORK.DIREQUITY_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN;  
        
//PROC PRINT DATA =  WORK.INVSTINS_EQ; RUN;  


/*------------------4.5. Direct Mezz + Equity --------------------*/  

DATA WORK.INVSTINS_LNEQ;
    SQL "SELECT MIN(INVINS.ACCOUNTINS) INVINS_ACCOUNTINS,
        SUM(A.AMOUNT2*(-1)) INVESTMENT, DATEPART(YYYY,MIN(A.CLOSEDATE)) INV_YEAR,
    MIN(VCPRT.PORTFOLIO) as PORTFOLIO, MIN (A.CURRENCY6) INST_CURR, MIN(SFA.NAME) AS SPONSOR,
    (case  when MIN(SFASTAT.DESCR) not like 'Exited Portfolio Co.%' then  '1' else '0' end ) as 'CMPACTIVESTATUS',
 MIN(SFA_CMP.NAME)  COMPANY,
MIN(SFA_CMP.CREATIONDATE) CREATIONDATE ,
MIN(INVINS.LIBELLE) FUND, 
(case 
		when MIN(INVINS.USERTEXT21) = 1 then 'Fund' 
		when MIN(INVINS.USERTEXT21) = 2 then 'Company' 
    end) as LP_TYPE
    FROM VCINVESTMENTINS INVINS 
        JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
        LEFT JOIN VCPROJECT VCP ON  VCP.ACCOUNT = VCINV.ACCOUNT AND VCP.WORKFLOW =
    (SELECT TOP 1 IQID FROM ADMWORKFLOW WHERE LIBELLE IN ('RGA Direct Mezzanine','RGA Equity Co-Investment'))
        LEFT JOIN SFAACCOUNT SFA ON SFA.IQID = VCP.USERTEXT7  
        LEFT JOIN SFAACCOUNT SFA_CMP ON SFA_CMP.IQID = VCINV.ACCOUNT                                                                                                                                                                                            
        LEFT JOIN SFAACCTSTAT SFASTAT ON SFA_CMP.STATUS = SFASTAT.CODE AND  SFASTAT.FILTER NOT LIKE '000%'                                                                                                                                                                                                    
    JOIN VCPORTFOLIOASSET VCPRTAST ON VCPRTAST.INVESTMENT = VCINV.IQID  AND  VCPRTAST.IQDELETED=0  
        JOIN VCPORTFOLIO VCPRT ON VCPRT.IQID = VCPRTAST.PORTFOLIO AND VCPRT.PORTFOLIO IN ('PDE - Direct Mezz + Equity') AND  VCPRT.IQDELETED=0  
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND ( OPT.DESCR like 'EQ - Purchase/Subscription (w/o Commitment)%'
    OR OPT.DESCR like 'LN - Funding (w/o commitment)%' )
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & DML(%DATE) & " AND ??FILTER
        GROUP BY  INVINS.ACCOUNTINS        " ;
    
    COLUMN SECURITY_ID;     
RUN;
//VCPRT.PORTFOLIO IN ('PDE - Direct Equity')
//PROC PRINT DATA =  WORK.INVSTINS_LNEQ; RUN;  
                                                                                                                                                                                                   
DATA WORK.INSTRPOS_LNEQ (KEEP = POSITION_DATE COMPANY_NAME SECURITY_NAME EXIT CURRENTCOST LASTVALUATION SECURITY_ID );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 );
RUN;
//AND SECURITY_CLASS_NAME <>"LOANS" 

DATA WORK.DIRLNEQ_LIST(RENAME = (SECURITY_ID=SECURITY_COMPANY_ID POSITION_DATE=REFERENCE_DATE));
MERGE WORK.INVSTINS_LNEQ(IN=IN1) WORK.INSTRPOS_LNEQ(IN=IN2);
BY SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN; 

//0809

PROC FAQUERY Query="IT Admin - Program Queries\Positions-PortRev" (DATE=%DATE) ; 
    TABLE "Default"  OUT=WORK.QRY_POSITIONS_PORTREV;
RUN;
//PROC PRINT DATA=WORK.QRY_POSITIONS_PORTREV; RUN;

DATA WORK.DIRLNEQ_LIST;
MERGE WORK.DIRLNEQ_LIST(IN=IN1) WORK.QRY_POSITIONS_PORTREV;
BY FUND  ;
If (IN1) then Output;
End;
RUN; 
//PROC PRINT DATA=WORK.DIRLNEQ_LIST; RUN;

DATA WORK.DIRLNEQ_LIST(DROP=FUND_ID FUND INVESTORNAME GAAP_BOOK_VALUE GL_COST_ELIM );
SET WORK.DIRLNEQ_LIST;
// COLUMN CURRENTCOST  TYPE=DOUBLE;  
     IF LP_TYPE = 'Fund' THEN CURRENTCOST = GAAP_BOOK_VALUE + GL_COST_ELIM; END;
RUN;

//PROC PRINT DATA=WORK.DIRLNEQ_LIST; RUN;
//0809


PROC MEANS DATA = DCE.FV_T_PORTCO_TRANSACTIONS(WHERE TRANSACTION_TYPE<>'LN05' AND TRANSACTION_TYPE<>'LN07' AND TRANSACTION_TYPE<>'EQ06') OUT=WORK.TIRR_LNEQ;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME; 
VAR  COMPANY_NAME;     
SUM CASH2(NAME=IRRNET);
RUN; 

PROC MEANS DATA =  WORK.DIRLNEQ_LIST OUT=WORK.TVALUATION_LNEQ;
CLASS SECURITY_COMPANY_ID REFERENCE_DATE; 
VAR  SECURITY_NAME;  
VAR  COMPANY_NAME;     
SUM LASTVALUATION(NAME=IRRNET);
RUN; 

DATA WORK.TIRR_LNEQ;
SET  WORK.TIRR_LNEQ(IN=T1) WORK.TVALUATION_LNEQ; 
IF IRRNET IS NULL THEN IRRNET=0; END; 

COLUMN SORT_IRR TYPE=INTEGER; 

IF T1 THEN SORT_IRR=0;  
ELSE SORT_IRR=1; 
REFERENCE_DATE=%DATE;
END; 

_OUTPUT_=IRRNET <>0 OR SORT_IRR=1;
RUN; 

PROC SORT DATA = WORK.TIRR_LNEQ; 
BY SECURITY_COMPANY_ID SECURITY_NAME COMPANY_NAME SORT_IRR REFERENCE_DATE; 
RUN; 

DATA WORK.DIRLNEQ_LIST1;
MERGE WORK.DIRLNEQ_LIST(IN=IN1) WORK.TIRR_LNEQ(IN=IN2);
By SECURITY_COMPANY_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                    
DATA DIRLNEQ_LIST1; 
SET WORK.DIRLNEQ_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN;  
        
//PROC PRINT DATA =  DIRLNEQ_LIST1; RUN;  
/*------------------4.5. Direct Mezz + Equity --------------------*/

/*------------------1. Portfolio Snapshot --------------------*/ 
DATA WORK.FUND_PORTSnap(DROP = CLOSEDATE ENDDATE); 
SET WORK.FUND_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= RETURNOFCAPITAL + LASTVALUATION;                                                                                                                                                                                     
RUN;                                                                                                                                                                                                     

DATA WORK.FUND_PORTSnap;
SET  WORK.FUND_PORTSnap; 
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Funds';
RUN;

PROC MEANS DATA=WORK.FUND_PORTSnap  OUT=WORK.FUND_PORTSnap_IRR;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=OPERATIONDATE);    
RUN; 

//PROC PRINT DATA = WORK.FUND_PORTSnap_IRR; RUN;                                                                                                                                                                                                      
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.FUND_PORTSnap  OUT=WORK.FUND_PORTSnap;                                        
CLASS FUND_ID;
VAR FUNDS;  
VAR FACTIVESTATUS;                                                                                                                                                                                                          
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN CAPITALINVESTED (NAME = CAPITALINVESTED);
MIN RETURNOFCAPITAL (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.FUND_PORTSnap; RUN;                                                                                                                                                                                                    

PROC MEANS DATA=WORK.FUND_PORTSnap  OUT=WORK.FUND_PORTSnap;                                        
VAR FUNDS; 
N  FUND_ID (NAME = ITD_FUNDS);   
SUM FACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                          
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;      
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PORTSnap; RUN; 

DATA WORK.FUND_PORTSnap;                                                                                                                                                                                                     
SET WORK.FUND_PORTSnap;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;                                                                                                                                                                                     
RUN;    
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PortSNP; RUN; 
                                                                                                                                                                                                    
DATA WORK.FUND_PORTSnap;
MERGE WORK.FUND_PORTSnap(IN=IN1) WORK.FUND_PORTSnap_IRR(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PORTSnap; RUN;  
                                                                                                                                                                                                    
/*******Directs*******/

DATA WORK.MEZZ_PORTSnap; 
SET WORK.DIRLOAN_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN; 

DATA WORK.EQUITY_PORTSnap; 
SET WORK.DIREQUITY_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN;                                                                                                                                                                                                      

DATA WORK.DIRECTS_PORTSnap; 
SET WORK.MEZZ_PORTSnap WORK.EQUITY_PORTSnap;  
RUN;                                                                                                                                                                                                    
     
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap; RUN;   
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap;
SET  WORK.DIRECTS_PORTSnap; 
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Direct Investments';
RUN;     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap  OUT=WORK.DIRECTS_PORTSnap_IRR;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=REFERENCE_DATE);    
RUN;      

PROC MEANS DATA=WORK.DIRECTS_PORTSnap  OUT=WORK.DIRECTS_PORTSnap_CNT;
CLASS COMPANY;                                                                                                                                                                                                         
VAR FUNDS;                                                                                                                                                                                                         
MIN CMPACTIVESTATUS(NAME = CMPACTIVESTATUS);                                                                                                                                                                                                     
RUN;
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap_CNT  OUT=WORK.DIRECTS_PORTSnap_CNT;
VAR FUNDS;                                                                                                                                                                                                        
N  COMPANY(NAME = ITD_FUNDS);   
SUM CMPACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                     
RUN;       
                                                                                                                                                                                                    
PROC PRINT DATA = WORK.DIRECTS_PORTSnap_CNT; RUN;                                                                                                                                                                                                     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap  OUT=WORK.DIRECTS_PORTSnap;                                        
CLASS SECURITY_COMPANY_ID;
VAR FUNDS;                                                                                                                                                                                                          
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN INVESTMENT (NAME = CAPITALINVESTED);
MIN EXIT (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.DIRECTS_PORTSnap; RUN;                                                                                                                                                                                                    

PROC MEANS DATA= WORK.DIRECTS_PORTSnap  OUT= WORK.DIRECTS_PORTSnap;                                        
VAR FUNDS;   
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.DIRLOAN_PortSNP; RUN;                                                                                                                                                                                                     

DATA WORK.DIRECTS_PORTSnap; 
SET WORK.DIRECTS_PORTSnap;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;                                                                                                                                                                                     
RUN;    
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_PortSNP; RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap;
MERGE WORK.DIRECTS_PORTSnap(IN=IN1) WORK.DIRECTS_PORTSnap_IRR(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap;
MERGE WORK.DIRECTS_PORTSnap(IN=IN1) WORK.DIRECTS_PORTSnap_CNT(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                      
                                                                                                                                                                                                  
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap; RUN;   

/*---------Total---------*/ 
DATA WORK.TOTAL_PORTSnap; 
SET WORK.FUND_PORTSnap WORK.DIRECTS_PORTSnap;  
RUN; 
                                                                                                                                                                                                    
PROC MEANS DATA= WORK.TOTAL_PORTSnap  OUT= WORK.TOTAL_PORTSnap;  
SUM ITD_FUNDS (NAME = ITD_FUNDS);   
SUM ACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                        
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;   

DATA  WORK.TOTAL_PORTSnap; 
SET  WORK.TOTAL_PORTSnap;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Total ITD';                                                                                                                                                                                                        
RUN; 
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.TOTAL_PORTSnap; RUN;   

DATA  WORK.TOT_FUND_PORTSnap(KEEP = IRRNET OPERATIONDATE) ; 
SET  WORK.FUND_LIST1;   
RUN;
                                                                                                                                                                                                    
DATA  WORK.TOT_LN_PORTSnap(KEEP = IRRNET REFERENCE_DATE) ; 
SET  WORK.DIRLOAN_LIST1;  
RUN;
                                                                                                                                                                                                    
DATA WORK.TOT_EQ_PORTSnap(KEEP = IRRNET REFERENCE_DATE) ; 
SET WORK.DIREQUITY_LIST1;  
RUN;                                                                                                                                                                                                      

DATA WORK.TOT_DIR_PORTSnap; 
SET WORK.TOT_LN_PORTSnap WORK.TOT_EQ_PORTSnap;  
RUN;                                                                                                                                                                                                    

DATA  WORK.TOT_DIR_PORTSnap(RENAME = (REFERENCE_DATE=OPERATIONDATE));
SET  WORK.TOT_DIR_PORTSnap;                                                                                                                                                                                                          
RUN;

DATA WORK.TOT_PORTSnap; 
SET WORK.TOT_FUND_PORTSnap WORK.TOT_DIR_PORTSnap;  
RUN; 

DATA WORK.TOT_PORTSnap;
SET  WORK.TOT_PORTSnap; 
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Total ITD';
RUN;
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.TOT_PORTSnap  OUT=WORK.TOT_PORTSnap_IRR;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=OPERATIONDATE);    
RUN;                                                                                                                                                                                                     
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.TOT_PORTSnap; RUN; 
PROC PRINT DATA = WORK.TOT_PORTSnap_IRR; RUN; 

DATA WORK.TOT_PORTSnap;
MERGE WORK.TOTAL_PORTSnap(IN=IN1) WORK.TOT_PORTSnap_IRR(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
/*--------Portfolio Sanpshot 2011-------*/                                                                                                                                                                                                   

%LET DATE_2011 = "01012011"d;
                                                                                                                                                                                                    
DATA WORK.FUND_PORTSnap_2011(DROP = ENDDATE); 
SET WORK.FUND_LIST1(WHERE CLOSEDATE>=%DATE_2011);  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= RETURNOFCAPITAL + LASTVALUATION;                                                                                                                                                                                     
RUN;
/*
PROC MEANS DATA=WORK.FUND_PORTSnap_2011  OUT=WORK.FUND_PORTSnap_2011;
CLASS FUND_ID;                                                                                                                                                                                                         
MIN CLOSEDATE(NAME=CLOSEDATE);    
RUN; 
*/                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PORTSnap_2011; RUN;                                                                                                                                                                                                    
                                                                                                                                                                                                    
DATA WORK.FUND_PORTSnap_2011;
SET  WORK.FUND_PORTSnap_2011; 
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Funds - Since 2011';
RUN;

PROC MEANS DATA=WORK.FUND_PORTSnap_2011  OUT=WORK.FUND_PORTSnap_IRR_2011;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=OPERATIONDATE);    
RUN; 

//PROC PRINT DATA = WORK.FUND_PORTSnap_IRR; RUN;                                                                                                                                                                                                      
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.FUND_PORTSnap_2011  OUT=WORK.FUND_PORTSnap_2011;                                        
CLASS FUND_ID;
VAR FUNDS;  
VAR FACTIVESTATUS;                                                                                                                                                                                                          
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN CAPITALINVESTED (NAME = CAPITALINVESTED);
MIN RETURNOFCAPITAL (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.FUND_PORTSnap; RUN;                                                                                                                                                                                                    

PROC MEANS DATA=WORK.FUND_PORTSnap_2011  OUT=WORK.FUND_PORTSnap_2011;                                        
VAR FUNDS; 
N  FUND_ID (NAME = ITD_FUNDS);   
SUM FACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                          
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;      
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PORTSnap; RUN; 

DATA WORK.FUND_PORTSnap_2011;                                                                                                                                                                                                     
SET WORK.FUND_PORTSnap_2011;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;                                                                                                                                                                                     
RUN;    
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PortSNP; RUN; 
                                                                                                                                                                                                    
DATA WORK.FUND_PORTSnap_2011;
MERGE WORK.FUND_PORTSnap_2011(IN=IN1) WORK.FUND_PORTSnap_IRR_2011(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.FUND_PORTSnap_2011; RUN; 
                                                                                                                                                                                                    
// Directs 2011

DATA WORK.MEZZ_PORTSnap_2011; 
SET WORK.DIRLOAN_LIST1(WHERE CREATIONDATE>=%DATE_2011);  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN; 

//PROC PRINT DATA = WORK.MEZZ_PORTSnap_2011; RUN; 
                                                                                                                                                                                                    
DATA WORK.EQUITY_PORTSnap_2011; 
SET WORK.DIREQUITY_LIST1(WHERE CREATIONDATE>=%DATE_2011);  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN;                                                                                                                                                                                                      
//PROC PRINT DATA = WORK.EQUITY_PORTSnap_2011; RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap_2011; 
SET WORK.MEZZ_PORTSnap_2011 WORK.EQUITY_PORTSnap_2011;  
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Direct Investments - Since 2011';                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    
     
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap_2011; RUN;   
/*                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap_2011;
SET  WORK.DIRECTS_PORTSnap_2011; 
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Direct Investments';
RUN;     
*/                                                                                                                                                                                                    
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap_2011  OUT=WORK.DIRECTS_PORTSnap_IRR_2011;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=REFERENCE_DATE);    
RUN;      

PROC MEANS DATA=WORK.DIRECTS_PORTSnap_2011  OUT=WORK.DIRECTS_PORTSnap_CNT_2011;
CLASS COMPANY;                                                                                                                                                                                                         
VAR FUNDS;                                                                                                                                                                                                         
MIN CMPACTIVESTATUS(NAME = CMPACTIVESTATUS);                                                                                                                                                                                                     
RUN;
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap_CNT_2011  OUT=WORK.DIRECTS_PORTSnap_CNT_2011;
VAR FUNDS;                                                                                                                                                                                                        
N  COMPANY(NAME = ITD_FUNDS);   
SUM CMPACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                     
RUN;       
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap_CNT; RUN;                                                                                                                                                                                                     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRECTS_PORTSnap_2011  OUT=WORK.DIRECTS_PORTSnap_2011;                                        
CLASS SECURITY_COMPANY_ID;
VAR FUNDS;                                                                                                                                                                                                          
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN INVESTMENT (NAME = CAPITALINVESTED);
MIN EXIT (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.DIRECTS_PORTSnap; RUN;                                                                                                                                                                                                    

PROC MEANS DATA= WORK.DIRECTS_PORTSnap_2011  OUT= WORK.DIRECTS_PORTSnap_2011;                                        
VAR FUNDS;   
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.DIRLOAN_PortSNP; RUN;                                                                                                                                                                                                     

DATA WORK.DIRECTS_PORTSnap_2011; 
SET WORK.DIRECTS_PORTSnap_2011;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;                                                                                                                                                                                     
RUN;    
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_PortSNP; RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap_2011;
MERGE WORK.DIRECTS_PORTSnap_2011(IN=IN1) WORK.DIRECTS_PORTSnap_IRR_2011(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRECTS_PORTSnap_2011;
MERGE WORK.DIRECTS_PORTSnap_2011(IN=IN1) WORK.DIRECTS_PORTSnap_CNT_2011(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                      
                                                                                                                                                                                                  
//PROC PRINT DATA = WORK.DIRECTS_PORTSnap_2011; RUN;   

//  Total 2011
DATA WORK.TOTAL_PORTSnap_2011; 
SET WORK.FUND_PORTSnap_2011 WORK.DIRECTS_PORTSnap_2011;  
RUN; 
                                                                                                                                                                                                    
PROC MEANS DATA= WORK.TOTAL_PORTSnap_2011  OUT= WORK.TOTAL_PORTSnap_2011;  
SUM ITD_FUNDS (NAME = ITD_FUNDS);   
SUM ACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                        
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;   

DATA  WORK.TOTAL_PORTSnap_2011; 
SET  WORK.TOTAL_PORTSnap_2011;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Total - Since 2011';                                                                                                                                                                                                        
RUN; 
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.TOTAL_PORTSnap; RUN;   

DATA  WORK.TOT_FUND_PORTSnap_2011(KEEP = IRRNET OPERATIONDATE) ; 
SET  WORK.FUND_LIST1(WHERE CLOSEDATE>=%DATE_2011);     
RUN;
                                                                                                                                                                                                    
DATA  WORK.TOT_LN_PORTSnap_2011(KEEP = IRRNET REFERENCE_DATE) ; 
SET  WORK.DIRLOAN_LIST1(WHERE CREATIONDATE>=%DATE_2011); 
RUN;
                                                                                                                                                                                                    
DATA WORK.TOT_EQ_PORTSnap_2011(KEEP = IRRNET REFERENCE_DATE) ; 
SET WORK.DIREQUITY_LIST1(WHERE CREATIONDATE>=%DATE_2011);  
RUN;                                                                                                                                                                                                      

DATA WORK.TOT_DIR_PORTSnap_2011(RENAME = (REFERENCE_DATE=OPERATIONDATE)); 
SET WORK.TOT_LN_PORTSnap_2011 WORK.TOT_EQ_PORTSnap_2011;  
RUN;                                                                                                                                                                                                    

//DATA  WORK.TOT_DIR_PORTSnap_2011(RENAME = (REFERENCE_DATE=OPERATIONDATE));
//SET  WORK.TOT_DIR_PORTSnap_2011;                                                                                                                                                                                                          
//RUN;

DATA WORK.TOT_PORTSnap_2011; 
SET WORK.TOT_FUND_PORTSnap_2011 WORK.TOT_DIR_PORTSnap_2011;  
COLUMN FUNDS TYPE=STRING; 
FUNDS = 'Total - Since 2011';                                                                                                                                                                                                        
RUN; 
                                                                                                                                                                                                   
PROC MEANS DATA=WORK.TOT_PORTSnap_2011  OUT=WORK.TOT_PORTSnap_IRR_2011;
VAR FUNDS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=OPERATIONDATE);    
RUN;                                                                                                                                                                                                     
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.TOT_PORTSnap; RUN; 
//PROC PRINT DATA = WORK.TOT_PORTSnap_IRR; RUN; 

DATA WORK.TOT_PORTSnap_2011;
MERGE WORK.TOTAL_PORTSnap_2011(IN=IN1) WORK.TOT_PORTSnap_IRR_2011(IN=IN2);
BY FUNDS;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                                  
/*--------Portfolio Sanpshot 2011-------*/                                                                                                                                                                                                   
                                                                                                                                                                                                      
DATA Portfolio_Snapshot; 
SET WORK.FUND_PORTSnap WORK.DIRECTS_PORTSnap WORK.TOT_PORTSnap;  
RUN;   

DATA Portfolio_Snapshot2011; 
SET WORK.FUND_PORTSnap_2011 WORK.DIRECTS_PORTSnap_2011 WORK.TOT_PORTSnap_2011;  
RUN;                                                                                                                                                                                                     
                                                                                                                                                                                                    
/*------------------2. Direct Mezzanine vs. Mezzanine Funds --------------------*/  
//4;Private Debt Fund
                                                                                                                                                                                                            
DATA WORK.FUND_MEZZ(DROP = CLOSEDATE ENDDATE); 
//SET WORK.FUND_LIST1(WHERE PORTFOLIO = 'PDE - Private Debt Funds');  
SET WORK.FUND_LIST1(WHERE Fund_Class3 = 'Private Debt Fund');  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= RETURNOFCAPITAL+ LASTVALUATION;                                                                                                                                                                                     
RUN;  

//PROC PRINT DATA = WORK.FUND_MEZZ; RUN;                                                                                                                                                                                                       

DATA WORK.FUND_MEZZ;
SET  WORK.FUND_MEZZ; 
COLUMN FUND_DIRECTS TYPE=STRING; 
FUND_DIRECTS = 'Mezzanine Funds';
COLUMN DIFF TYPE=STRING;                                                                                                                                                                                                         
DIFF = 'Difference in Returns';                                                                                                                                                                                                        
RUN;     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.FUND_MEZZ  OUT=WORK.FUND_MEZZ_IRR;
VAR FUND_DIRECTS;                                                                                                                                                                                                         
IRR IRRNET(NAME=IRRNET DATE=OPERATIONDATE);    
RUN;      

PROC MEANS DATA=WORK.FUND_MEZZ  OUT=WORK.FUND_MEZZ;                                        
//CLASS PORTFOLIO FUND_ID;
CLASS Fund_Class3 FUND_ID;
VAR FUND_DIRECTS;   
VAR DIFF;
VAR FACTIVESTATUS;                                                                                                                                                                                                         
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN CAPITALINVESTED (NAME = CAPITALINVESTED);
MIN RETURNOFCAPITAL (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.FUND_MEZZ; RUN;                                                                                                                                                                                                              
                                                                                                                                                                                                            
PROC MEANS DATA=WORK.FUND_MEZZ  OUT=WORK.FUND_MEZZ;                                        
VAR FUND_DIRECTS;  
VAR DIFF;  
N  FUND_ID (NAME = ITD_FUNDS);   
SUM FACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                        
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;                                                                                                                                                                                                    

//PROC PRINT DATA = WORK.FUND_MEZZ; RUN;                                                                                                                                                                                                            
                                                                                                                                                                                                            
DATA WORK.FUND_MEZZ; 
SET WORK.FUND_MEZZ;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;                                                                                                                                                                                     
RUN;    
                                                                                                                                                                                                    
DATA WORK.FUND_MEZZ;
MERGE WORK.FUND_MEZZ(IN=IN1) WORK.FUND_MEZZ_IRR(IN=IN2);
BY FUND_DIRECTS;
If (IN1 and IN2) then Output;
End;
RUN;  
//PROC PRINT DATA = WORK.FUND_MEZZ; RUN;                                                                                                                                                                                                      

/*-------------Direct Mezz --------------*/
DATA WORK.DIRLOAN_MEZZ; 
SET WORK.DIRLOAN_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRLOAN_MEZZ;
SET  WORK.DIRLOAN_MEZZ; 
COLUMN FUND_DIRECTS TYPE=STRING; 
FUND_DIRECTS = 'Direct Mezzanine';
COLUMN DIFF TYPE=STRING;                                                                                                                                                                                                          
DIFF = 'Difference in Returns';                                                                                                                                                                                                           
RUN;     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLOAN_MEZZ  OUT=WORK.DIRLOAN_MEZZ_IRR;
VAR FUND_DIRECTS;  
IRR IRRNET(NAME=IRRNET DATE=REFERENCE_DATE); 
RUN;      
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLOAN_MEZZ  OUT=WORK.DIRLOAN_MEZZ_CNT;
CLASS COMPANY;                                                                                                                                                                                                         
VAR FUND_DIRECTS;                                                                                                                                                                                                         
MIN CMPACTIVESTATUS(NAME = CMPACTIVESTATUS);                                                                                                                                                                                                     
RUN;
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_MEZZ_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLOAN_MEZZ_CNT  OUT=WORK.DIRLOAN_MEZZ_CNT;
VAR FUND_DIRECTS;                                                                                                                                                                                                        
N  COMPANY(NAME = ITD_FUNDS);   
SUM CMPACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                     
RUN;       
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_MEZZ_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLOAN_MEZZ  OUT=WORK.DIRLOAN_MEZZ;                                        
CLASS SECURITY_COMPANY_ID;
VAR FUND_DIRECTS;  
VAR DIFF;                                                                                                                                                                                                        
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN INVESTMENT (NAME = CAPITALINVESTED);
MIN EXIT (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

PROC MEANS DATA= WORK.DIRLOAN_MEZZ  OUT= WORK.DIRLOAN_MEZZ;                                        
VAR FUND_DIRECTS;    
VAR DIFF;                                                                                                                                                                                                        
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;                                                                                                                                                                                                    

DATA WORK.DIRLOAN_MEZZ; 
SET WORK.DIRLOAN_MEZZ;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;
RUN;    
                                                                                                                                                                                                    
DATA WORK.DIRLOAN_MEZZ;
MERGE WORK.DIRLOAN_MEZZ(IN=IN1) WORK.DIRLOAN_MEZZ_IRR(IN=IN2);
BY FUND_DIRECTS;
If (IN1 and IN2) then Output;
End;
RUN;   
                                                                                                                                                                                                    
DATA WORK.DIRLOAN_MEZZ;
MERGE WORK.DIRLOAN_MEZZ(IN=IN1) WORK.DIRLOAN_MEZZ_CNT(IN=IN2);
BY FUND_DIRECTS;
If (IN1 and IN2) then Output;
End;
RUN;        

/*-------------Mezz + Equity--------------*/

DATA WORK.DIRLNEQ_MEZZ; 
SET WORK.DIRLNEQ_LIST1;  
COLUMN TOTALVALUE TYPE=FLOAT; 
TOTALVALUE= EXIT + LASTVALUATION;                                                                                                                                                                                     
RUN; 
                                                                                                                                                                                                    
DATA WORK.DIRLNEQ_MEZZ;
SET  WORK.DIRLNEQ_MEZZ; 
COLUMN FUND_DIRECTS TYPE=STRING; 
FUND_DIRECTS = 'Direct Mezzanine + Equity';
COLUMN DIFF TYPE=STRING;                                                                                                                                                                                                          
DIFF = 'Difference in Returns';                                                                                                                                                                                                           
RUN;     
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLNEQ_MEZZ  OUT=WORK.DIRLNEQ_MEZZ_IRR;
VAR FUND_DIRECTS;  
IRR IRRNET(NAME=IRRNET DATE=REFERENCE_DATE); 
RUN;      
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLNEQ_MEZZ  OUT=WORK.DIRLNEQ_MEZZ_CNT;
CLASS COMPANY;                                                                                                                                                                                                         
VAR FUND_DIRECTS;                                                                                                                                                                                                         
MIN CMPACTIVESTATUS(NAME = CMPACTIVESTATUS);                                                                                                                                                                                                     
RUN;
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_MEZZ_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLNEQ_MEZZ_CNT  OUT=WORK.DIRLNEQ_MEZZ_CNT;
VAR FUND_DIRECTS;                                                                                                                                                                                                        
N  COMPANY(NAME = ITD_FUNDS);   
SUM CMPACTIVESTATUS(NAME = ACTIVESTATUS);                                                                                                                                                                                                     
RUN;       
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRLOAN_MEZZ_CNT; RUN;  
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIRLNEQ_MEZZ  OUT=WORK.DIRLNEQ_MEZZ;                                        
CLASS SECURITY_COMPANY_ID;
VAR FUND_DIRECTS;  
VAR DIFF;                                                                                                                                                                                                        
MIN CURRENTCOST (NAME = BOOKVALUE);  
MIN INVESTMENT (NAME = CAPITALINVESTED);
MIN EXIT (NAME = REALIZED);                                                                                                                                                                                                        
MIN LASTVALUATION (NAME = MARKETVALUE);
MIN TOTALVALUE (NAME = TOTALVALUE);                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

PROC MEANS DATA= WORK.DIRLNEQ_MEZZ  OUT= WORK.DIRLNEQ_MEZZ;                                        
VAR FUND_DIRECTS;    
VAR DIFF;                                                                                                                                                                                                        
SUM BOOKVALUE (NAME = BOOKVALUE);  
SUM CAPITALINVESTED (NAME = CAPITALINVESTED);
SUM REALIZED (NAME = REALIZED);                                                                                                                                                                                                        
SUM MARKETVALUE (NAME = MARKETVALUE);
SUM TOTALVALUE (NAME = TOTALVALUE);   
RUN;                                                                                                                                                                                                    

DATA WORK.DIRLNEQ_MEZZ; 
SET WORK.DIRLNEQ_MEZZ;  
COLUMN MOC TYPE=FLOAT; 
MOC = TOTALVALUE/CAPITALINVESTED;
RUN;    
                                                                                                                                                                                                    
DATA WORK.DIRLNEQ_MEZZ;
MERGE WORK.DIRLNEQ_MEZZ(IN=IN1) WORK.DIRLNEQ_MEZZ_IRR(IN=IN2);
BY FUND_DIRECTS;
If (IN1 and IN2) then Output;
End;
RUN;   
                                                                                                                                                                                                    
DATA WORK.DIRLNEQ_MEZZ;
MERGE WORK.DIRLNEQ_MEZZ(IN=IN1) WORK.DIRLNEQ_MEZZ_CNT(IN=IN2);
BY FUND_DIRECTS;
If (IN1 and IN2) then Output;
End;
RUN;        

//PROC PRINT DATA= WORK.DIRLNEQ_MEZZ; RUN;

/*-------------Difference --------------*/ 
DATA WORK.DIRLNEQ_DIFF (KEEP = DIFF MOC IRRNET); 
SET WORK.DIRLNEQ_MEZZ;
RUN;                                                                                                                                                                                                         
                                                                                                                                                                                                    
DATA WORK.FUND_MEZZ_DIFF (KEEP = DIFF MOC IRRNET); 
SET WORK.FUND_MEZZ;
RUN;                                                                                                                                                                                                         
                                                                                                                                                                                                    
DATA WORK.FUND_MEZZ_DIFF (RENAME = (MOC=MOC_F IRRNET=IRRNET_F)); 
SET WORK.FUND_MEZZ_DIFF;
RUN;                                                                                                                                                                                                         
                                                                                                                                                                                                  
DATA WORK.DIFF_LNEQ;
MERGE WORK.DIRLNEQ_DIFF(IN=IN2) WORK.FUND_MEZZ_DIFF(IN=IN1) ;
BY DIFF; 
If (IN1 and IN2) then Output;
End;                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

DATA WORK.DIFF_LNEQ(RENAME = (DIFF=FUND_DIRECTS));
SET WORK.DIFF_LNEQ;  
MOC = MOC-MOC_F;
IRRNET = IRRNET-IRRNET_F;                                                                                                                                                                                                       
RUN;                                                                                                                                                                                                         

DATA WORK.DIFF_LNEQ(DROP = MOC_F IRRNET_F);
SET WORK.DIFF_LNEQ;  
RUN;                                                                                                                                                                                                         

//PROC PRINT DATA = WORK.DIFF_MEZZ; RUN;  
                                                                                                                                                                                                            
DATA LNEQ_DIRvsFUND; 
SET WORK.DIRLNEQ_MEZZ WORK.FUND_MEZZ WORK.DIFF_LNEQ;  
RUN;  

PROC PRINT DATA = LNEQ_DIRvsFUND; RUN;  

/*----------Mezz + Equity--------------- */

//PROC PRINT DATA = WORK.DIRLOAN_MEZZ; RUN;                                                                                                                                                                                                       

/*-------------Difference --------------*/ 
DATA WORK.DIR_MEZZ_DIFF (KEEP = DIFF MOC IRRNET); 
SET WORK.DIRLOAN_MEZZ;
RUN;                                                                                                                                                                                                         
/*                                                                                                                                                                                                    
DATA WORK.FUND_MEZZ_DIFF (KEEP = DIFF MOC IRRNET); 
SET WORK.FUND_MEZZ;
RUN;                                                                                                                                                                                                         
                                                                                                                                                                                                    
DATA WORK.FUND_MEZZ_DIFF (RENAME = (MOC=MOC_F IRRNET=IRRNET_F)); 
SET WORK.FUND_MEZZ_DIFF;
RUN; 
*/
                                                                                                                                                                                                  
DATA WORK.DIFF_MEZZ;
MERGE WORK.DIR_MEZZ_DIFF(IN=IN2) WORK.FUND_MEZZ_DIFF(IN=IN1) ;
BY DIFF; 
If (IN1 and IN2) then Output;
End;                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                    

DATA WORK.DIFF_MEZZ (RENAME = (DIFF=FUND_DIRECTS));
SET WORK.DIFF_MEZZ;  
MOC = MOC-MOC_F;
IRRNET = IRRNET-IRRNET_F;                                                                                                                                                                                                       
RUN;                                                                                                                                                                                                         

DATA WORK.DIFF_MEZZ (DROP = MOC_F IRRNET_F);
SET WORK.DIFF_MEZZ;  
RUN;                                                                                                                                                                                                         

//PROC PRINT DATA = WORK.DIFF_MEZZ; RUN;  
                                                                                                                                                                                                            
DATA MEZZ_DIRvsFUND; 
SET WORK.DIRLOAN_MEZZ WORK.FUND_MEZZ WORK.DIFF_MEZZ;  
RUN;  

//PROC PRINT DATA =  MEZZ_DIRvsFUND; RUN;                                                                                                                                                                                                              
                                          
/*------------------6. Commitments & Investments --------------------*/                                                                                                                                                                                                     
DATA WORK.COMMITMENT_PY;
SQL "SELECT A.IQID AS FUND_ID,
    A.FUND as 'Limited Partnership' ,
    (case 
		when A.USERTEXT42 = '1' then 'Real Estate Joint Ventures (REJV)' 
		when A.USERTEXT42 = '2' then 'Alternatives Debt Fund' 
		when A.USERTEXT42 = '3' then 'Direct Private Debt' 
		when A.USERTEXT42 = '4' then 'Private Debt Fund' 
		when A.USERTEXT42 = '5' then 'Structured Alternatives Debt Fund' 
		when A.USERTEXT42 = '6' then 'Structured Alternatives Direct Debt' 
		when A.USERTEXT42 = '7' then 'Alternatives Equity Fund' 
		when A.USERTEXT42 = '8' then 'Direct Private Equity' 
		when A.USERTEXT42 = '9' then 'Private Equity Fund' 
		when A.USERTEXT42 = '10' then 'Structured Alternatives Direct Equity' 
		when A.USERTEXT42 = '11' then 'Structured Alternatives Equity Fund' 
   end) as Structure,
    A.CLOSINGDATE,
    DATEPART(YYYY,A.CLOSINGDATE) AS COMMITMENT_YEAR,                                       
    A.CURRENCY1                                
    FROM VCFUND A
    JOIN ADMROLE REG ON A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity') 
    JOIN VCFUNDSTAT FSTAT ON A.FSTATUS = FSTAT.CODE AND FSTAT.DESCR = 'Fund (Closed Ended)'
      WHERE A.IQDELETED=0 AND ??FILTER AND A.CLOSINGDATE <= "& %DATE &" AND  DATEPART(YYYY,A.CLOSINGDATE) = "& YEAR(%DATE) &" - 1                                   
  ORDER BY DATEPART(YYYY,A.CLOSINGDATE),A.CURRENCY1 DESC ";

COLUMN FUND_ID; RUN;    
//PROC PRINT DATA = WORK.FUNDMAST; RUN;

DATA WORK.tmp1_CI (KEEP = FUND_ID COMMITMENT);
SET FCE.FUNDPOSITIONS (WHERE POSITION_DATE=%DATE) ;
RUN;

DATA COMMITMENT_PY;
MERGE WORK.COMMITMENT_PY(IN=IN1) WORK.tmp1_CI(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;     
//----------
DATA WORK.COMMITMENT_CY;
SQL "SELECT A.IQID AS FUND_ID,
    A.FUND as 'Limited Partnership' ,
    (case 
		when A.USERTEXT42 = '1' then 'Real Estate Joint Ventures (REJV)' 
		when A.USERTEXT42 = '2' then 'Alternatives Debt Fund' 
		when A.USERTEXT42 = '3' then 'Direct Private Debt' 
		when A.USERTEXT42 = '4' then 'Private Debt Fund' 
		when A.USERTEXT42 = '5' then 'Structured Alternatives Debt Fund' 
		when A.USERTEXT42 = '6' then 'Structured Alternatives Direct Debt' 
		when A.USERTEXT42 = '7' then 'Alternatives Equity Fund' 
		when A.USERTEXT42 = '8' then 'Direct Private Equity' 
		when A.USERTEXT42 = '9' then 'Private Equity Fund' 
		when A.USERTEXT42 = '10' then 'Structured Alternatives Direct Equity' 
		when A.USERTEXT42 = '11' then 'Structured Alternatives Equity Fund' 
   end) as Structure,
    A.CLOSINGDATE,
    DATEPART(YYYY,A.CLOSINGDATE) AS COMMITMENT_YEAR,                                       
    A.CURRENCY1                                
    FROM VCFUND A
    JOIN ADMROLE REG ON A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity') 
    JOIN VCFUNDSTAT FSTAT ON A.FSTATUS = FSTAT.CODE AND FSTAT.DESCR = 'Fund (Closed Ended)'
      WHERE A.IQDELETED=0 AND ??FILTER AND A.CLOSINGDATE <= "& %DATE &" AND DATEPART(YYYY,A.CLOSINGDATE) = "& YEAR(%DATE) &"                                    
  ORDER BY DATEPART(YYYY,A.CLOSINGDATE),A.CURRENCY1 DESC ";

COLUMN FUND_ID; RUN;    
//PROC PRINT DATA = WORK.FUNDMAST; RUN;

DATA WORK.tmp1_CI (KEEP = FUND_ID COMMITMENT);
SET FCE.FUNDPOSITIONS (WHERE POSITION_DATE=%DATE) ;
RUN;

DATA COMMITMENT_CY;
MERGE WORK.COMMITMENT_CY(IN=IN1) WORK.tmp1_CI(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                                                                 

/*----Investments------*/                                                                                                                                                                                                                                                
DATA WORK.INVESTMENT_PY;
    SQL "SELECT INVINS.LIBELLE INVINS_LIBELLE,
           (case 
		when MAX(INVINS.USERTEXT41) = '1' then 'Debt Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '2' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '3' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '4' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '5' then 'Distressed Debt' 
		when MAX(INVINS.USERTEXT41) = '6' then 'Real Asset Debt' 
		when MAX(INVINS.USERTEXT41) = '7' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '8' then 'Subordinated Loan/Mezzanine Funds' 
		when MAX(INVINS.USERTEXT41) = '9' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '10' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '11' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '12' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '13' then 'Equity Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '14' then 'Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '15' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '16' then 'Warrants' 
		when MAX(INVINS.USERTEXT41) = '17' then 'Buyout' 
		when MAX(INVINS.USERTEXT41) = '18' then 'Growth' 
		when MAX(INVINS.USERTEXT41) = '19' then 'Real Asset Equity' 
		when MAX(INVINS.USERTEXT41) = '20' then 'Secondary' 
		when MAX(INVINS.USERTEXT41) = '21' then 'Venture Capital' 
		when MAX(INVINS.USERTEXT41) = '22' then 'Structured Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '23' then 'Structured Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '24' then 'Senior Loan' 
		when MAX(INVINS.USERTEXT41) = '25' then 'Subordinated Loan' 
        end) as Security ,  SUM(A.AMOUNT2*(-1)) InvestedCapital, DATEPART(YYYY,MIN(A.CLOSEDATE)) INVESTMENT_YEAR ,
        MIN(A.CURRENCY6) AS  CURRENCY1                                                                                                                                                                                                                                                                                                                                                                                  
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'LN - Funding (w/o commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & %DATE & " AND ??FILTER
        AND  DATEPART(YYYY,A.CLOSEDATE) = "& YEAR(%DATE) &" - 1                                                                                                                                    
        GROUP BY  INVINS.LIBELLE
UNION                                                                                                                                                
SELECT INVINS.LIBELLE INVINS_LIBELLE,
           (case 
		when MAX(INVINS.USERTEXT41) = '1' then 'Debt Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '2' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '3' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '4' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '5' then 'Distressed Debt' 
		when MAX(INVINS.USERTEXT41) = '6' then 'Real Asset Debt' 
		when MAX(INVINS.USERTEXT41) = '7' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '8' then 'Subordinated Loan/Mezzanine Funds' 
		when MAX(INVINS.USERTEXT41) = '9' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '10' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '11' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '12' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '13' then 'Equity Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '14' then 'Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '15' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '16' then 'Warrants' 
		when MAX(INVINS.USERTEXT41) = '17' then 'Buyout' 
		when MAX(INVINS.USERTEXT41) = '18' then 'Growth' 
		when MAX(INVINS.USERTEXT41) = '19' then 'Real Asset Equity' 
		when MAX(INVINS.USERTEXT41) = '20' then 'Secondary' 
		when MAX(INVINS.USERTEXT41) = '21' then 'Venture Capital' 
		when MAX(INVINS.USERTEXT41) = '22' then 'Structured Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '23' then 'Structured Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '24' then 'Senior Loan' 
		when MAX(INVINS.USERTEXT41) = '25' then 'Subordinated Loan' 
         end) as Security ,  SUM(A.AMOUNT2*(-1)) InvestedCapital, DATEPART(YYYY,MIN(A.CLOSEDATE)) INVESTMENT_YEAR,
MIN(A.CURRENCY6) AS  CURRENCY1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'EQ - Purchase/Subscription (w/o Commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & %DATE & " AND ??FILTER
        AND DATEPART(YYYY,A.CLOSEDATE) = "& YEAR(%DATE) &" - 1                                                                                                                                    
        GROUP BY  INVINS.LIBELLE                                                                                                                                                
    " ;
COLUMN INSTRUMENTFATHER_ID;     
RUN;

//PROC PRINT DATA  = WORK.INVSTINS_CI; RUN; 

DATA INVESTMENT_PY; 
SET WORK.INVESTMENT_PY;  
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//Current Year                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.INVESTMENT_CY;
    SQL "SELECT INVINS.LIBELLE INVINS_LIBELLE,
           (case 
		when MAX(INVINS.USERTEXT41) = '1' then 'Debt Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '2' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '3' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '4' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '5' then 'Distressed Debt' 
		when MAX(INVINS.USERTEXT41) = '6' then 'Real Asset Debt' 
		when MAX(INVINS.USERTEXT41) = '7' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '8' then 'Subordinated Loan/Mezzanine Funds' 
		when MAX(INVINS.USERTEXT41) = '9' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '10' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '11' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '12' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '13' then 'Equity Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '14' then 'Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '15' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '16' then 'Warrants' 
		when MAX(INVINS.USERTEXT41) = '17' then 'Buyout' 
		when MAX(INVINS.USERTEXT41) = '18' then 'Growth' 
		when MAX(INVINS.USERTEXT41) = '19' then 'Real Asset Equity' 
		when MAX(INVINS.USERTEXT41) = '20' then 'Secondary' 
		when MAX(INVINS.USERTEXT41) = '21' then 'Venture Capital' 
		when MAX(INVINS.USERTEXT41) = '22' then 'Structured Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '23' then 'Structured Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '24' then 'Senior Loan' 
		when MAX(INVINS.USERTEXT41) = '25' then 'Subordinated Loan' 
        end) as Security ,  SUM(A.AMOUNT2*(-1)) InvestedCapital, DATEPART(YYYY,MIN(A.CLOSEDATE)) INVESTMENT_YEAR ,
MIN(A.CURRENCY6) AS  CURRENCY1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'LN - Funding (w/o commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & %DATE & " AND ??FILTER AND DATEPART(YYYY,A.CLOSEDATE) = "& YEAR(%DATE) &"                                                                                                                                      
        GROUP BY  INVINS.LIBELLE
UNION                                                                                                                                                
SELECT INVINS.LIBELLE INVINS_LIBELLE,
           (case 
		when MAX(INVINS.USERTEXT41) = '1' then 'Debt Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '2' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '3' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '4' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '5' then 'Distressed Debt' 
		when MAX(INVINS.USERTEXT41) = '6' then 'Real Asset Debt' 
		when MAX(INVINS.USERTEXT41) = '7' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '8' then 'Subordinated Loan/Mezzanine Funds' 
		when MAX(INVINS.USERTEXT41) = '9' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '10' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '11' then 'Senior Secured Loan' 
		when MAX(INVINS.USERTEXT41) = '12' then 'Subordinated Loan' 
		when MAX(INVINS.USERTEXT41) = '13' then 'Equity Hedge Fund' 
		when MAX(INVINS.USERTEXT41) = '14' then 'Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '15' then 'Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '16' then 'Warrants' 
		when MAX(INVINS.USERTEXT41) = '17' then 'Buyout' 
		when MAX(INVINS.USERTEXT41) = '18' then 'Growth' 
		when MAX(INVINS.USERTEXT41) = '19' then 'Real Asset Equity' 
		when MAX(INVINS.USERTEXT41) = '20' then 'Secondary' 
		when MAX(INVINS.USERTEXT41) = '21' then 'Venture Capital' 
		when MAX(INVINS.USERTEXT41) = '22' then 'Structured Alternatives Common Stock' 
		when MAX(INVINS.USERTEXT41) = '23' then 'Structured Alternatives Preferred Stock' 
		when MAX(INVINS.USERTEXT41) = '24' then 'Senior Loan' 
		when MAX(INVINS.USERTEXT41) = '25' then 'Subordinated Loan' 
         end) as Security ,  SUM(A.AMOUNT2*(-1)) InvestedCapital, DATEPART(YYYY,MIN(A.CLOSEDATE)) INVESTMENT_YEAR ,
MIN(A.CURRENCY6) AS  CURRENCY1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'EQ - Purchase/Subscription (w/o Commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE <=  " & %DATE & " AND ??FILTER  AND DATEPART(YYYY,A.CLOSEDATE) = "& YEAR(%DATE) &"                                                                                                                                    
        GROUP BY  INVINS.LIBELLE                                                                                                                                                
    " ;
COLUMN INSTRUMENTFATHER_ID;     
RUN;

//PROC PRINT DATA  = WORK.INVSTINS_CI; RUN; 

DATA INVESTMENT_CY; 
SET WORK.INVESTMENT_CY;  
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*------------------7. Directs Contibution Graph--------------------*/   
//AND  A.CLOSEDATE>='1/1/2011'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.INVSTINS_CI_GPH;
    SQL "SELECT SUM(A.PRINCIPAL2*(-1)) CONTRIBUTION, DATEPART(YYYY,A.CLOSEDATE) INVESTMENT_YEAR                                 
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'LN - Funding (w/o commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0  AND A.CLOSEDATE <=  " & %DATE & "  AND ??FILTER
         
    GROUP BY DATEPART(YYYY,A.CLOSEDATE)                                                                                                                                                                                                                                                                                                                                                                                                                                                            
        
UNION                                                                                                                                                
SELECT SUM(A.AMOUNT2*(-1)) CONTRIBUTION, DATEPART(YYYY,A.CLOSEDATE) INVESTMENT_YEAR                                
    FROM VCINVESTMENTINS INVINS
    JOIN VCINVESTMENT VCINV ON VCINV.IQID = INVINS.INVESTMENT
    JOIN VCINVESTMENTOP A  ON A.INVESTMENTINS=INVINS.IQID 
    JOIN VCINVESTOPTYPE OPT ON OPT.CODE = A.TYPEINVESTOP AND OPT.DESCR like 'EQ - Purchase/Subscription (w/o Commitment)%' 
    JOIN ADMROLE REG ON VCINV.IQREGIONID = REG.IQID AND A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity')
    WHERE  A.IQDELETED=0 AND A.CLOSEDATE>='1/1/2011' AND A.CLOSEDATE <=  " & %DATE & " AND ??FILTER
                                                                                                                                        
        GROUP BY  DATEPART(YYYY,A.CLOSEDATE)                                                                                                                                            
    " ;
COLUMN CONTRIBUTION;     
RUN;

PROC MEANS DATA=WORK.INVSTINS_CI_GPH  OUT=WORK.INVSTINS_CI_GPH;                                        
CLASS INVESTMENT_YEAR;
SUM CONTRIBUTION (NAME = CONTRIBUTION);  
RUN;   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//PROC PRINT DATA  = WORK.INVSTINS_CI_GPH; RUN; 

DATA DIRECT_CommInv_Graph; 
SET WORK.INVSTINS_CI_GPH;  
RUN;  
/*------------------7. Directs Contibution Graph--------------------*/ 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*------------------8. YTD Production vs. Plan----------------------*/                                                                                                                                                                                                     
//CLASS FUND_ID OPERATIONDATE; 

DATA WORK.YTD_ACTUAL(KEEP = FUND_ID FUNDNAME OPERATIONDATE CASH CATEGORY  CONTRIBUTE DISTRIBUTE CAPITALCALLED CAPITALINVESTED DISTRIBUTION);
SET FCE.FUNDOPERATIONS (WHERE OPERATIONDATE <= %DATE AND YEAR(OPERATIONDATE) = YEAR(%DATE) );
//SET FCE.FUNDOPERATIONS (WHERE YEAR(OPERATIONDATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CATEGORY TYPE=STRING; CATEGORY = 'Funds'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.YTD_ACTUAL;
MERGE WORK.FUNDMAST(IN=IN1) WORK.YTD_ACTUAL(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

PROC MEANS DATA = WORK.YTD_ACTUAL OUT=WORK.YTD_ACTUAL;
CLASS CATEGORY; 
SUM CAPITALCALLED(NAME=YTD_CALLED);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//PROC PRINT DATA  = WORK.YTD_ACTUAL; RUN;   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.PYTD_ACTUAL(KEEP = FUND_ID FUNDNAME OPERATIONDATE CASH CATEGORY CONTRIBUTE DISTRIBUTE CAPITALCALLED CAPITALINVESTED DISTRIBUTION);
SET FCE.FUNDOPERATIONS (WHERE OPERATIONDATE <= DATEADD("YEAR",-1,%DATE) AND YEAR(OPERATIONDATE) = YEAR(%DATE) -1);
//SET FCE.FUNDOPERATIONS (WHERE YEAR(OPERATIONDATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CATEGORY TYPE=STRING; 
CATEGORY = 'Funds';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.PYTD_ACTUAL;
MERGE WORK.FUNDMAST(IN=IN1) WORK.PYTD_ACTUAL(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

PROC MEANS DATA = WORK.PYTD_ACTUAL OUT=WORK.PYTD_ACTUAL;
CLASS CATEGORY; 
SUM CAPITALCALLED(NAME=PYTD_CALLED);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//PROC PRINT DATA  = WORK.PYTD_ACTUAL; RUN;   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.YTD_FUNDS;
MERGE WORK.YTD_ACTUAL(IN=IN1) WORK.PYTD_ACTUAL(IN=IN2);
By CATEGORY;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA  = WORK.YTD_FUNDS; RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*-----------Directs-----------*/

//WORK.INVSTINS
DATA WORK.DIRECTMAST;
SET  WORK.INVSTINS  WORK.INVSTINS_EQ;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//PROC PRINT DATA  = WORK.DIRECTMAST; RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.YTD_ACTUAL_DIR(KEEP = COMPANY_NAME SECURITY_COMPANY_ID SECURITY_NAME REFERENCE_DATE INVESTMENT2 CATEGORY ACTUAL);
SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE REFERENCE_DATE  <= %DATE AND YEAR(REFERENCE_DATE) = YEAR(%DATE) );
//SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE YEAR(REFERENCE_DATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CATEGORY TYPE=STRING; CATEGORY = 'Direct Private Debt & Equity';   
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA  = WORK.YTD_ACTUAL_DIR; RUN; 
DATA WORK.YTD_ACTUAL_DIR(RENAME = (SECURITY_COMPANY_ID=SECURITY_ID ));
SET WORK.YTD_ACTUAL_DIR ;
RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.YTD_ACTUAL_DIR;
MERGE WORK.DIRECTMAST(IN=IN1) WORK.YTD_ACTUAL_DIR(IN=IN2);
BY SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

//PROC PRINT DATA  = WORK.YTD_ACTUAL_DIR; RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.YTD_ACTUAL_DIR OUT=WORK.YTD_ACTUAL_DIR;
CLASS CATEGORY; 
SUM INVESTMENT2(NAME=YTD_CALLED);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//PROC PRINT DATA  = WORK.YTD_ACTUAL_DIR; RUN; 

/*--------Directs PY--------*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

DATA WORK.PYTD_ACTUAL_DIR(KEEP = COMPANY_NAME SECURITY_COMPANY_ID SECURITY_NAME REFERENCE_DATE INVESTMENT2 CATEGORY );
SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE REFERENCE_DATE <= DATEADD("YEAR",-1,%DATE) AND YEAR(REFERENCE_DATE) = YEAR(%DATE) -1);
//SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE YEAR(REFERENCE_DATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CATEGORY TYPE=STRING; 
CATEGORY = 'Direct Private Debt & Equity';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA  = WORK.YTD_ACTUAL_DIR; RUN; 
DATA WORK.PYTD_ACTUAL_DIR(RENAME = (SECURITY_COMPANY_ID=SECURITY_ID ));
SET WORK.PYTD_ACTUAL_DIR ;
RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.PYTD_ACTUAL_DIR;
MERGE WORK.DIRECTMAST(IN=IN1) WORK.PYTD_ACTUAL_DIR(IN=IN2);
BY SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

//PROC PRINT DATA  = WORK.PYTD_ACTUAL_DIR; RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.PYTD_ACTUAL_DIR OUT=WORK.PYTD_ACTUAL_DIR;
CLASS CATEGORY; 
SUM INVESTMENT2(NAME=PYTD_CALLED);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

//PROC PRINT DATA  = WORK.PYTD_ACTUAL_DIR; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.YTD_DIRECTS;
MERGE WORK.YTD_ACTUAL_DIR(IN=IN1) WORK.PYTD_ACTUAL_DIR(IN=IN2);
By CATEGORY;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA  = WORK.YTD_DIRECTS; RUN;   

DATA YTD_PRODvsPLAN;   
SET WORK.YTD_FUNDS WORK.YTD_DIRECTS;   
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
/*------------------8. YTD Production vs. Plan --------------------*/   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*----------------10. Contributions and Distributions---------------*/
/*---Select either CASH2 or AMOUNT2-----*/    
//DATA WORK.TRANS(KEEP = AMOUNT2); 

/*--------TTM--------*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
DATA WORK.DIRECTCAPINV_TTM(KEEP = COMPANY_NAME SECURITY_COMPANY_ID SECURITY_NAME REFERENCE_DATE CASH2 OP_YEAR CONTRIBUTE DISTRIBUTE );
SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE REFERENCE_DATE > DATEADD("YEAR",-1,%DATE));
//SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE YEAR(REFERENCE_DATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN OP_YEAR TYPE=STRING; 
OP_YEAR = 'TTM ' +  FORMAT(%DATE,'M/d/yyyy') ;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CONTRIBUTE TYPE=FLOAT; 
IF CASH2<=0 THEN CONTRIBUTE=CASH2*(-1); END;  
COLUMN DISTRIBUTE TYPE=FLOAT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
IF CASH2>0 THEN  DISTRIBUTE=CASH2; END;
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRECTCAPINV_TTM; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
DATA WORK.DIRECTCAPINV_TTM(RENAME = (SECURITY_COMPANY_ID=SECURITY_ID ));
SET WORK.DIRECTCAPINV_TTM ;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
DATA WORK.DIRECTCAPINV_LN_TTM;
MERGE WORK.INVSTINS(IN=IN1) WORK.DIRECTCAPINV_TTM(IN=IN2);
By SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA = WORK.DIRECTCAPINV_LN; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

PROC MEANS DATA = WORK.DIRECTCAPINV_LN_TTM OUT=WORK.DIRECTCAPINV_LN_TTM;
CLASS OP_YEAR; 
SUM CONTRIBUTE(NAME=CONTRIBUTION);
SUM DISTRIBUTE(NAME=DISTRIBUTION);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA=WORK.DIRECTCAPINV_LN; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.DIRECTCAPINV_EQ_TTM;
MERGE WORK.INVSTINS_EQ(IN=IN1) WORK.DIRECTCAPINV_TTM(IN=IN2);
By SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA=WORK.DIRECTCAPINV_EQ; RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.DIRECTCAPINV_EQ_TTM OUT=WORK.DIRECTCAPINV_EQ_TTM;
CLASS OP_YEAR ; 
SUM CONTRIBUTE(NAME=CONTRIBUTION);
SUM DISTRIBUTE(NAME=DISTRIBUTION);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

//PROC PRINT DATA=WORK.DIRECTCAPINV_EQ; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.FUNDCAPINV_TTM(KEEP = FUND_ID FUNDNAME OPERATIONDATE CASH OP_YEAR CONTRIBUTE DISTRIBUTE CAPITALCALLED CAPITALINVESTED DISTRIBUTION);
SET FCE.FUNDOPERATIONS (WHERE OPERATIONDATE > DATEADD("YEAR",-1,%DATE) );
//SET FCE.FUNDOPERATIONS (WHERE YEAR(OPERATIONDATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN OP_YEAR TYPE=STRING; 
OP_YEAR = 'TTM ' +  FORMAT(%DATE,'M/d/yyyy');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;

//PROC PRINT DATA=WORK.FUNDCAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.FUNDCAPINV_TTM;
MERGE WORK.FUNDMAST(IN=IN1) WORK.FUNDCAPINV_TTM(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA=WORK.FUNDCAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.FUNDCAPINV_TTM OUT=WORK.FUNDCAPINV_TTM;
CLASS OP_YEAR; 
SUM CAPITALCALLED(NAME=CONTRIBUTION);
SUM DISTRIBUTION(NAME=DISTRIBUTION);
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
/*--------TTM--------*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.DIRECTCAPINV(KEEP = COMPANY_NAME SECURITY_COMPANY_ID SECURITY_NAME REFERENCE_DATE CASH2 OP_YEAR CONTRIBUTE DISTRIBUTE );
SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE YEAR(REFERENCE_DATE)< YEAR(%DATE));
//SET DCE.FV_T_PORTCO_TRANSACTIONS(WHERE YEAR(REFERENCE_DATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN OP_YEAR TYPE=STRING; 
OP_YEAR = YEAR(REFERENCE_DATE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CONTRIBUTE TYPE=FLOAT; 
IF CASH2<=0 THEN CONTRIBUTE=CASH2*(-1); END;  
COLUMN DISTRIBUTE TYPE=FLOAT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
IF CASH2>0 THEN  DISTRIBUTE=CASH2; END;
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.DIRECTCAPINV; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.DIRECTCAPINV(RENAME = (SECURITY_COMPANY_ID=SECURITY_ID ));
SET WORK.DIRECTCAPINV ;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
DATA WORK.DIRECTCAPINV_LN;
MERGE WORK.INVSTINS(IN=IN1) WORK.DIRECTCAPINV(IN=IN2);
By SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA = WORK.DIRECTCAPINV_LN; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

PROC MEANS DATA = WORK.DIRECTCAPINV_LN OUT=WORK.DIRECTCAPINV_LN;
CLASS OP_YEAR; 
SUM CONTRIBUTE(NAME=CONTRIBUTION);
SUM DISTRIBUTE(NAME=DISTRIBUTION);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA=WORK.DIRECTCAPINV_LN; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.DIRECTCAPINV_EQ;
MERGE WORK.INVSTINS_EQ(IN=IN1) WORK.DIRECTCAPINV(IN=IN2);
By SECURITY_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA=WORK.DIRECTCAPINV_EQ; RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.DIRECTCAPINV_EQ OUT=WORK.DIRECTCAPINV_EQ;
CLASS OP_YEAR ; 
SUM CONTRIBUTE(NAME=CONTRIBUTION);
SUM DISTRIBUTE(NAME=DISTRIBUTION);
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

//PROC PRINT DATA=WORK.DIRECTCAPINV_EQ; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.FUNDCAPINV(KEEP = FUND_ID FUNDNAME OPERATIONDATE CASH OP_YEAR CONTRIBUTE DISTRIBUTE CAPITALCALLED CAPITALINVESTED DISTRIBUTION);
SET FCE.FUNDOPERATIONS (WHERE YEAR(OPERATIONDATE)< YEAR(%DATE));
//SET FCE.FUNDOPERATIONS (WHERE YEAR(OPERATIONDATE)=2015);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN OP_YEAR TYPE=STRING; 
OP_YEAR = YEAR(OPERATIONDATE);
/*                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
COLUMN CONTRIBUTE TYPE=FLOAT; 
IF CASH<=0 THEN CONTRIBUTE=CASH; END;  
COLUMN DISTRIBUTE TYPE=FLOAT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
IF CASH>0 THEN  DISTRIBUTE=CASH; END;
*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;
 
//PROC PRINT DATA=WORK.FUNDCAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.FUNDCAPINV;
MERGE WORK.FUNDMAST(IN=IN1) WORK.FUNDCAPINV(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;

//PROC PRINT DATA=WORK.FUNDCAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
PROC MEANS DATA = WORK.FUNDCAPINV OUT=WORK.FUNDCAPINV;
CLASS OP_YEAR; 
SUM CAPITALCALLED(NAME=CONTRIBUTION);
SUM DISTRIBUTION(NAME=DISTRIBUTION);
RUN; 

//PROC PRINT DATA=WORK.FUNDCAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA WORK.CAPINV;
SET WORK.DIRECTCAPINV_LN WORK.DIRECTCAPINV_EQ WORK.FUNDCAPINV WORK.DIRECTCAPINV_LN_TTM  WORK.DIRECTCAPINV_EQ_TTM  WORK.FUNDCAPINV_TTM ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
//PROC PRINT DATA=WORK.CAPINV; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
PROC MEANS DATA =WORK.CAPINV OUT=WORK.CAPINV;
CLASS OP_YEAR; 
SUM CONTRIBUTION(NAME=CONTRIBUTION);
SUM DISTRIBUTION(NAME=DISTRIBUTION);
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//PROC PRINT DATA=WORK.CAPINV; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
DATA CAPINV; 
SET WORK.CAPINV;  
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*--------------13. Book Value and Market Value--------------*/ 

%LET DATE_IN = %DATE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
%LET DATE = "31122008"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
DATA WORK.FUND08 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;

DATA WORK.DIR08 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122009"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND09 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR09 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122010"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND10 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR10 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

%LET DATE = "31122011"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND11 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR11 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122012"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND12 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR12 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;     

%LET DATE = "31122013"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND13 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR13 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
      
%LET DATE = "31122014"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND14 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR14 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122015"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND15 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR15 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;

//PROC PRINT DATA=WORK.DIR15; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122016"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND16 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR16 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%LET DATE = "31122017"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND17 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR17 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;

%LET DATE = "31122018"d;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUND18 (KEEP = FUND_ID POSITION_DATE VAL_YEAR CURRENTCOST ADJUSTEDVALUATION);
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE AND (CURRENTCOST IS NOT NULL OR ADJUSTEDVALUATION IS NOT NULL ) ) ;
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIR18 (KEEP = COMPANY_NAME SECURITY_ID POSITION_DATE VAL_YEAR CURRENTCOST LASTVALUATION );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND LENGTH(COMPANY_NAME)>0 AND (CURRENTCOST IS NOT NULL OR LASTVALUATION IS NOT NULL ) );
COLUMN VAL_YEAR TYPE=STRING; VAL_YEAR = YEAR(POSITION_DATE);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUNDBKMK;
SET  WORK.FUND08 WORK.FUND09 WORK.FUND10 WORK.FUND11 WORK.FUND12 WORK.FUND13 WORK.FUND14 WORK.FUND15 WORK.FUND16 WORK.FUND17 WORK.FUND18 ; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUNDBKMK;
MERGE WORK.FUNDMAST(IN=IN1) WORK.FUNDBKMK(IN=IN2); By FUND_ID;
If (IN1 and IN2) then Output; End; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
//PROC PRINT DATA=WORK.FUND08; RUN;
DATA WORK.DIRBKMK;
SET  WORK.DIR08 WORK.DIR09 WORK.DIR10 WORK.DIR11 WORK.DIR12 WORK.DIR13 WORK.DIR14 WORK.DIR15 WORK.DIR16 WORK.DIR17  WORK.DIR18; RUN;

DATA WORK.DIRBKMK;
MERGE WORK.DIRECTMAST(IN=IN1) WORK.DIRBKMK(IN=IN2); BY SECURITY_ID;
If (IN1 and IN2) then Output; End; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//PROC PRINT DATA= WORK.DIRBKMK; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.DIRBKMK(RENAME= (SECURITY_ID = FUND_ID  LASTVALUATION = ADJUSTEDVALUATION)) ; 
SET  WORK.DIRBKMK; 
RUN;

//PROC PRINT DATA= WORK.DIRBKMK; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.ALLBKMK; SET  WORK.FUNDBKMK WORK.DIRBKMK; RUN;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//PROC PRINT DATA=WORK.ALL08; RUN;
DATA WORK.ALLBKMK; SET WORK.ALLBKMK(WHERE POSITION_DATE<=%DATE_IN ); RUN;

//PROC PRINT DATA=WORK.ALL08; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
PROC MEANS DATA =WORK.ALLBKMK OUT=WORK.ALLBKMK;
CLASS VAL_YEAR;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
SUM CURRENTCOST(NAME=BOOK_VALUE); 
SUM ADJUSTEDVALUATION(NAME=MARKET_VALUE);
RUN; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA BOOKandMARKET;
SET  WORK.ALLBKMK; 
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//PROC PRINT DATA=WORK.ALLBKMK; RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

/*--------------13. Book Value and Market Value--------------*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
/*------------------9. Portfolio Holdings--------------------*/                                                                                                                                                                                                       

PROC MEANS DATA=WORK.FUND_LIST  OUT=WORK.FUND_PortHold;                                        
//CLASS PORTFOLIO;
CLASS FUND_CLASS3;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
SUM CURRENTCOST (NAME = CURRENTCOST);  
SUM REMAININGCOMMITMENT (NAME = REMAINCOMMIT);
SUM LASTVALUATION (NAME = ADJUSTVAL);
RUN;      

//PROC PRINT DATA = WORK.FUND_PortHold; RUN;
                                                                                                                                                                                                  
PROC MEANS DATA=WORK.DIRLOAN_LIST  OUT=WORK.MEZZ_PortHold;                                        
SUM CURRENTCOST (NAME = CURRENTCOST);  
SUM LASTVALUATION (NAME = ADJUSTVAL);
RUN;  

DATA WORK.MEZZ_PortHold;
SET  WORK.MEZZ_PortHold; 
//COLUMN PORTFOLIO TYPE=STRING; PORTFOLIO = 'PDE - Direct Mezzanine';
COLUMN FUND_CLASS3 TYPE=STRING; FUND_CLASS3 = 'PDE - Direct Mezzanine';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;      
                                                                                                                                                                                                    
//PROC PRINT DATA = WORK.MEZZ_PortHold; RUN;
                                                                                                                                                                                                    
PROC MEANS DATA=WORK.DIREQUITY_LIST  OUT=WORK.EQ_PortHold;                                        
SUM CURRENTCOST (NAME = CURRENTCOST);  
SUM LASTVALUATION (NAME = ADJUSTVAL);
RUN;   

DATA WORK.EQ_PortHold;
SET  WORK.EQ_PortHold; 
//COLUMN PORTFOLIO TYPE=STRING; PORTFOLIO = 'PDE - Direct Equity';
COLUMN FUND_CLASS3 TYPE=STRING; FUND_CLASS3 = 'PDE - Direct Equity';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                

RUN; 
                                                                                                                                                                                                        
//PROC PRINT DATA = WORK.EQ_PortHold; RUN;

DATA WORK.PortHold(RENAME = (FUND_CLASS3 = PORTFOLIO));
SET  WORK.FUND_PortHold WORK.MEZZ_PortHold WORK.EQ_PortHold; 
RUN; 
                                                                                                                                                                 
%LET DATE = "31122011"d;

// MIN(VCPRT.PORTFOLIO) as PORTFOLIO
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
DATA WORK.FUNDMAST_2011;
SQL "SELECT A.IQID AS FUND_ID,
(case 
		when MIN(A.USERTEXT42) = '4' then 'Private Debt Fund' 
		when MIN(A.USERTEXT42) = '9' then 'Private Equity Fund'                                                                                                                                                                             
end) as  FUND_CLASS3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    
     FROM VCFUND A
    JOIN VCSUBSCRIBER VCSUB ON VCSUB.FUND = A.IQID
    JOIN VCPORTFOLIOASSET VCPRTAST ON VCPRTAST.SUBSCRIBER = VCSUB.IQID   
    JOIN VCPORTFOLIO VCPRT ON VCPRT.IQID = VCPRTAST.PORTFOLIO                                                                                                                                                                            
    JOIN ADMROLE REG ON A.IQREGIONID = REG.IQID AND REG.NAME IN ('Private Debt & Equity') 
     JOIN VCFUNDSTAT FSTAT ON A.FSTATUS = FSTAT.CODE AND FSTAT.DESCR = 'Fund (Closed Ended)'
        WHERE A.IQDELETED=0 AND ??FILTER
    GROUP BY   A.IQID  ";

COLUMN FUND_ID; RUN;       

DATA WORK.FUND_LIST_2011(KEEP = FUND_ID FUND INVESTOR_ID INVESTORNAME CURRENTCOST REMAININGCOMMITMENT CAPITALINVESTED RETURNOFCAPITAL ADJUSTEDVALUATION );
SET FCE.FUNDINVESTORPOSITIONS (WHERE POSITION_DATE=%DATE) ;
RUN;                                                                                                                                                                                     
                                                                                                                                                                                    
DATA WORK.FUND_LIST_2011;
MERGE WORK.FUNDMAST_2011(IN=IN1) WORK.FUND_LIST_2011(IN=IN2);
By FUND_ID;
If (IN1 and IN2) then Output;
End;
RUN;
                                                                                                                                                                                                   
DATA WORK.DIRLOAN_LIST_2011 (KEEP = POSITION_DATE COMPANY_NAME SECURITY_NAME EXIT CURRENTCOST LASTVALUATION SECURITY_ID );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND SECURITY_CLASS_NAME ="LOANS" AND LENGTH(COMPANY_NAME)>0 );
RUN;  
                                                                                                                                                                                                    
DATA WORK.DIREQUITY_LIST_2011 (KEEP = POSITION_DATE COMPANY_NAME SECURITY_NAME EXIT CURRENTCOST LASTVALUATION SECURITY_ID );
SET DCE.REFINSTRUMENTPOSITIONS (WHERE POSITION_DATE=%DATE AND SECURITY_CLASS_NAME <>"LOANS" AND LENGTH(COMPANY_NAME)>0 );
RUN;  

PROC MEANS DATA=WORK.FUND_LIST_2011  OUT=WORK.FUND_PortHold_2011;                                        
//CLASS PORTFOLIO;
CLASS FUND_CLASS3;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
SUM CURRENTCOST (NAME = CURRENTCOST_2011);  
SUM REMAININGCOMMITMENT (NAME = REMAINCOMMIT_2011);
SUM ADJUSTEDVALUATION (NAME = ADJUSTVAL_2011);
RUN; 

PROC MEANS DATA=WORK.DIRLOAN_LIST_2011  OUT=WORK.MEZZ_PortHold_2011;                                        
SUM CURRENTCOST (NAME = CURRENTCOST_2011);  
SUM LASTVALUATION (NAME = ADJUSTVAL_2011);
RUN;  

DATA WORK.MEZZ_PortHold_2011;
SET  WORK.MEZZ_PortHold_2011; 
//COLUMN PORTFOLIO TYPE=STRING; PORTFOLIO = 'PDE - Direct Mezzanine';
COLUMN FUND_CLASS3 TYPE=STRING; FUND_CLASS3 = 'PDE - Direct Mezzanine';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
RUN;

PROC MEANS DATA=WORK.DIREQUITY_LIST_2011  OUT=WORK.EQ_PortHold_2011;                                        
SUM CURRENTCOST (NAME = CURRENTCOST_2011);  
SUM LASTVALUATION (NAME = ADJUSTVAL_2011);
RUN;    
                                                                                                                                                                                                        
DATA WORK.EQ_PortHold_2011;
SET  WORK.EQ_PortHold_2011; 
//COLUMN PORTFOLIO TYPE=STRING; PORTFOLIO = 'PDE - Direct Equity';
COLUMN FUND_CLASS3 TYPE=STRING; FUND_CLASS3 = 'PDE - Direct Equity';
RUN;  
                                                                                                                                                                                                    
DATA WORK.PortHold_2011(RENAME = (FUND_CLASS3 = PORTFOLIO));
SET  WORK.FUND_PortHold_2011 WORK.MEZZ_PortHold_2011 WORK.EQ_PortHold_2011; 
RUN;     
                                                                                                                                                                                                    
DATA WORK.PortHold;
MERGE WORK.PortHold(IN=IN1) WORK.PortHold_2011(IN=IN2);
//BY FUND_CLASS3;
By PORTFOLIO;
If (IN1 and IN2) then Output;
End;
RUN; 
                                                                                                                                                                                                    
DATA WORK.PORT_HOLDINGS;
SET  WORK.PortHold; 
COLUMN CURRCOSTCHG TYPE=FLOAT;    
IF (CURRENTCOST_2011 IS NULL OR CURRENTCOST_2011 = 0) THEN CURRCOSTCHG=0; ELSE CURRCOSTCHG =  (CURRENTCOST-CURRENTCOST_2011)/CURRENTCOST_2011; END; 
                                                                                                                                                                                                        
COLUMN VALCHG TYPE=FLOAT;                                                                                                                                                                                                         
IF (ADJUSTVAL_2011 IS NULL OR ADJUSTVAL_2011 = 0) THEN VALCHG=0; ELSE VALCHG =  (ADJUSTVAL - ADJUSTVAL_2011)/ADJUSTVAL_2011; END;  
                                                                                                                                                                                                        
COLUMN REMCOMMCHG TYPE=FLOAT;                                                                                                                                                                                                        
IF (REMAINCOMMIT_2011 IS NULL OR REMAINCOMMIT_2011 = 0) THEN REMCOMMCHG=0; ELSE REMCOMMCHG =   (REMAINCOMMIT-REMAINCOMMIT_2011)/REMAINCOMMIT_2011;END;                                                                                                                                                                                                          
RUN;

PROC MEANS DATA=WORK.PORT_HOLDINGS  OUT=WORK.PORT_HOLDINGS_TOT;                                        
SUM CURRENTCOST (NAME = CURRENTCOST);  
SUM ADJUSTVAL (NAME = ADJUSTVAL);
SUM REMAINCOMMIT (NAME = REMAINCOMMIT); 
SUM CURRENTCOST_2011 (NAME = CURRENTCOST_2011);  
SUM ADJUSTVAL_2011 (NAME = ADJUSTVAL_2011);
SUM REMAINCOMMIT_2011 (NAME = REMAINCOMMIT_2011);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
RUN;  

DATA WORK.PORT_HOLDINGS_TOT;
SET  WORK.PORT_HOLDINGS_TOT; 
COLUMN PORTFOLIO TYPE=STRING; PORTFOLIO = 'Total';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
COLUMN CURRCOSTCHG TYPE=FLOAT;    
IF (CURRENTCOST_2011 IS NULL OR CURRENTCOST_2011 = 0) THEN CURRCOSTCHG=0; ELSE CURRCOSTCHG =  (CURRENTCOST-CURRENTCOST_2011)/CURRENTCOST_2011; END; 
                                                                                                                                                                                                        
COLUMN VALCHG TYPE=FLOAT;                                                                                                                                                                                                         
IF (ADJUSTVAL_2011 IS NULL OR ADJUSTVAL_2011 = 0) THEN VALCHG=0; ELSE VALCHG =  (ADJUSTVAL - ADJUSTVAL_2011)/ADJUSTVAL_2011; END;  
                                                                                                                                                                                                        
COLUMN REMCOMMCHG TYPE=FLOAT;                                                                                                                                                                                                        
IF (REMAINCOMMIT_2011 IS NULL OR REMAINCOMMIT_2011 = 0) THEN REMCOMMCHG=0; ELSE REMCOMMCHG =   (REMAINCOMMIT-REMAINCOMMIT_2011)/REMAINCOMMIT_2011;END;                                                                                                                                                                                                          
RUN;   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
DATA PORT_HOLDINGS;
SET  WORK.PORT_HOLDINGS WORK.PORT_HOLDINGS_TOT ;
RUN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
/*------------------9. Portfolio Holdings--------------------*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                    
